<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.erp.dao.RoomDao">

	<select id="getRoomByIdForUpdate" parameterType="long" resultType="com.edu.erp.model.TRoom">
		select
		tr.id id,
		tr.room_name room_name,
		tr.room_code room_code,
		tr.bu_id bu_id,
		tr.branch_id branch_id,
		tr.room_num room_num,
		tr.remark remark,
		tr.status status
		from T_ROOM tr
		where id = #{id} for update
	</select>

	<select id="queryById" parameterType="long" resultType="com.edu.erp.model.TRoom">
		select
		tr.id id,
		tr.room_name room_name,
		tr.room_code room_code,
		tr.bu_id bu_id,
		tr.branch_id branch_id,
		tr.room_num room_num,
		tr.remark remark,
		tr.status status
		from T_ROOM tr
		where id = #{id}
	</select>

	<select id="pageRoom" parameterType="map" resultType="com.edu.erp.model.TRoom">
		select
		tr.id id,
		tr.room_name room_name,
		tr.room_code room_code,
		tr.bu_id bu_id,
		tr.branch_id branch_id,
		tr.room_num room_num,
		tr.remark remark,
		tr.status status,
		toi.org_name branch_name
		from T_ROOM tr
		left join tab_organization_info toi on tr.branch_id = toi.id
		<trim prefix="where" prefixOverrides="and">
			<if test="bu_id !=null and bu_id != -1 and bu_id != ''">tr.bu_id=#{bu_id}</if>
			<if test="branch_id != null and branch_id != -1 and branch_id != ''">
				AND tr.branch_id = #{branch_id}
			</if>
			<if test="per_branch_ids != null and per_branch_ids != ''">
				AND tr.branch_id in (${per_branch_ids})
			</if>
			<if test="queryKey !=null">and (tr.room_code like '%${queryKey}%' or tr.room_name like '%${queryKey}%')</if>
			and tr.status != 0
		</trim>
		order by tr.branch_id,room_code DESC
	</select>
	
	<select id="listRoom" parameterType="map" resultType="com.edu.erp.model.TRoom">
		select
		tr.id id,
		tr.room_name room_name,
		tr.room_code room_code,
		tr.bu_id bu_id,
		tr.branch_id branch_id,
		tr.room_num room_num,
		tr.remark remark,
		tr.status status,
		toi.org_name branch_name
		from T_ROOM tr
		left join tab_organization_info toi on tr.branch_id = toi.id
		<trim prefix="where" prefixOverrides="and">
			<if test="bu_id !=null and bu_id != -1 and bu_id != ''">tr.bu_id=#{bu_id}</if>
			<if test="branch_id != null and branch_id != -1 and branch_id != ''">
				AND tr.branch_id = #{branch_id}
			</if>
			<if test="per_branch_ids != null and per_branch_ids != ''">
				AND tr.branch_id in (${per_branch_ids})
			</if>
			<if test="queryKey !=null">and (tr.room_code like '%${queryKey}%' or tr.room_name like '%${queryKey}%')</if>
			and tr.status != 0
		</trim>
		order by tr.branch_id, tr.room_code
	</select>

	<insert id="insertRoom" parameterType="com.edu.erp.model.TRoom">
		<selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE">
			select SEQ_T_ROOM.nextval as id from dual
		</selectKey>
		insert into t_room
		(id,room_name,room_code,bu_id,branch_id,room_num,remark, create_user,
		create_time,
		update_user,
		update_time,
		status
		)
		values
		(#{id,jdbcType=NUMERIC},
		#{room_name,jdbcType=VARCHAR},
		#{room_code,jdbcType=VARCHAR},
		#{bu_id,jdbcType=NUMERIC},
		#{branch_id,jdbcType=NUMERIC},
		#{room_num,jdbcType=NUMERIC},
		#{remark,jdbcType=VARCHAR},
		#{create_user,jdbcType=NUMERIC},
		sysdate,
		#{update_user,jdbcType=NUMERIC},
		#{update_time,jdbcType=DATE},
		#{status,jdbcType=NUMERIC})
	</insert>

	<update id="updateRoom" parameterType="com.edu.erp.model.TRoom">
		update t_room 
		<trim prefix="set" suffixOverrides=",">
			<if test="room_name !=null and room_name != ''">room_name=#{room_name,jdbcType=VARCHAR}, </if>
			<if test="room_code !=null and room_code != ''">room_code=#{room_code,jdbcType=VARCHAR}, </if>
			<if test="bu_id !=null">bu_id=#{bu_id,jdbcType=NUMERIC}, </if>
			<if test="branch_id !=null">branch_id=#{branch_id,jdbcType=NUMERIC}, </if>
			<if test="room_num !=null">room_num=#{room_num,jdbcType=NUMERIC}, </if>
			<if test="remark !=null and remark != ''">remark=#{remark,jdbcType=VARCHAR}, </if>
			<if test="update_user !=null">update_user=#{update_user,jdbcType=NUMERIC}, </if>
			<if test="status !=null">status=#{status,jdbcType=NUMERIC}, </if>
			update_time=sysdate
		</trim>
		where id=#{id}
	</update>
	
</mapper>