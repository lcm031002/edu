<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.erp.dao.ChangeEventDao">

	<!--转正员工状态更改 -->
	<update id="updateemployeestate" parameterType="java.util.Map">
		update
		tab_employee_info a set a.entertype=#{enterType}
		where
		a.id=#{employee_id}
	</update>

	<!--人事异动点击详情处理 -->
	<update id="updateChangeEvent" parameterType="java.util.Map">
		update
		tab_hrm_changeevent thc
		set thc.handler_id = #{handler_id},
		thc.approval_status =#{approval_status},
		final_opinion=#{outcome,jdbcType=VARCHAR},
		<if test="remark!=null">
			thc.enclosure=#{remark},
		</if>
		thc.task_id =#{task_id},
		thc.last_update_time =
		sysdate,
		step=#{step},
		is_effect=#{is_effect}
		where thc.id =
		#{applyid}
	</update>
	
	<!--人事异动参数表 插入数据 -->
	<insert id="insertEventParam" parameterType="java.util.List">
		insert into Tab_Hrm_Changeevent_Param
		(id ,applyid, Parametername,
		Parameterkey, Parametervalue)
		select
		seq_hrm_changeevent_param.nextval,A.*
		from(
		<foreach collection="list" item="item" separator="union all"
			index="index">
			select
			#{item.applyid},
			#{item.Parameterkey},
			#{item.Parameterkey},
			#{item.Parametervalue}
			from dual
		</foreach>
		) A
	</insert>
	
	<resultMap type="com.edu.erp.model.TabHrmChangeEvent"
		id="TabHrmChangeEventMap">
		<id property="id" column="id" />
		<result property="employee_id" column="employee_id" />
		<result property="employee_name" column="employee_name" />
		<result property="organiser" column="organiser" />
		<result property="organiser_name" column="organiser_name" />
		<result property="application_time" column="application_time" />
		<result property="last_update_time" column="last_update_time" />
		<result property="application_type" column="application_type" />
		<result property="application_name" column="application_name" />
		<result property="approval_status" column="approval_status" />
		<result property="flnal_opinion" column="flnal_opinion" />
		<result property="is_effect" column="is_effect" />
		<result property="handler_id" column="handler_id" />
		<result property="handler_name" column="handler_name" />
		<result property="task_id" column="task_id" />
		<result property="enclosure" column="enclosure" />
		<result property="bu_id" column="bu_id" />
		<result property="bu_name" column="bu_name" />
		<result property="branch_id" column="branch_id" />
		<result property="branch_name" column="branch_name" />
		<result property="tha_is_effect" column="tha_is_effect" />
		<result property="event_id" column="event_id" />
		<result property="step" column="step" />
	</resultMap>
		<!--通过异动id 来查询 -->
	<select id="querylastchangeInfo" resultMap="TabHrmChangeEventMap"
		parameterType="java.util.Map">
		select thc.id               id,
       thc.employee_id      employee_id,
       thc.organiser        organiser,
       thc.application_time application_time,
       thc.last_update_time last_update_time,
       thc.application_type application_type,
       thc.approval_status  approval_status,
       thc.final_opinion    flnal_opinion,
       thc.handler_id       handler_id,
       thc.task_id          task_id,
       thc.enclosure        enclosure,
       thc.step             step
		from tab_hrm_changeevent thc where thc.id=#{applyid}
	</select>
	<!--人事异动历史 -->
	<insert id="insertChangeeventHt" parameterType="com.edu.erp.model.TabHrmChangeEvent">
		insert into
		tab_hrm_changeevent_ht
		(id,
		employee_id,
		organiser,
		application_time,
		application_type,
		handler_id,
		approval_status,
		handler_opinion,
		is_effect,
		task_id,
		enclosure,
		last_update_time,
		step,
		event_id)
		values
		(seq_hrm_changeevent_ht.nextval,
		#{employee_id,jdbcType=NUMERIC},
		#{organiser,jdbcType=NUMERIC},
		#{application_time},
		#{application_type,jdbcType=NUMERIC},
		#{handler_id,jdbcType=VARCHAR},
		#{approval_status,jdbcType=NUMERIC},
		#{flnal_opinion,jdbcType=VARCHAR},
		#{is_effect,jdbcType=NUMERIC},
		#{task_id,jdbcType=VARCHAR},
		#{enclosure,jdbcType=VARCHAR},
		sysdate,
		#{step,jdbcType=NUMERIC},
		#{id,jdbcType=NUMERIC}
		)

	</insert>
	
	<!--人事异动插入数据 -->
	<insert id="insertEvent" parameterType="java.util.Map">
		insert into
		TAB_HRM_CHANGEEVENT
		(id,
		EMPLOYEE_ID,
		Organiser,
		Application_Time,
		Application_Type,
		APPROVAL_STATUS,
		Final_Opinion,
		IS_EFFECT,
		Handler_Id,
		 Task_id,
		Enclosure,
		Last_Update_Time,
		step)
		values
		(seq_hrm_changeevent.nextval,
		#{employee_id},
		#{Organiser_id},
		sysdate,
		#{application_type},
		1,
		null,
		1,
		#{handler_id},
		#{task_id},
		null,
		sysdate,
		#{step})
	</insert>
	
	<!--流程id 人事异动表 -->
	<select id="selectChangeId" parameterType="java.util.Map"
		resultType="java.lang.Long">
		select id
		from TAB_HRM_CHANGEEVENT a
		where a.task_id=#{task_id}
	</select>
</mapper>