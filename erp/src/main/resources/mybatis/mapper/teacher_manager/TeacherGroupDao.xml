<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.erp.dao.TeacherGroupDao">

	<resultMap type="com.edu.erp.model.TeacherGroup" id="teacherGroupMap">
		<id property="id" column="id" />
		<result property="teach_group_name" column="teach_group_name" />
		<result property="status" column="status" />
		<result property="status_name" column="status_name" />
		<result property="bu_id" column="bu_id" />
		<result property="bu_name" column="bu_name" />
		<result property="city_id" column="city_id" />
		<result property="city_name" column="city_name" />
		<result property="create_user" column="create_user" />
		<result property="create_time" column="create_time" />
		<result property="update_user" column="update_user" />
		<result property="update_time" column="update_time" />
		<result property="create_user_name" column="create_user_name" />
		<result property="update_user_name" column="update_user_name" />

		<collection property="leaderList" column="teach_group_id"
			javaType="ArrayList" ofType="com.edu.erp.model.TeacherLeader">
			<id property="id" column="teacher_leader_id" />
			<result property="employee_id" column="employee_id" />
			<result property="teacher_id" column="teacher_id1" />
			<result property="teacher_name" column="teacher_name1" />
		</collection>

		<collection property="teacherList" column="teach_group_id"
			javaType="ArrayList" ofType="com.edu.erp.model.TeacherGroupRef">
			<id property="id" column="teacher_group_ref_id" />
			<result property="teacher_id" column="teacher_id" />
			<result property="teacher_name" column="teacher_name2" />
		</collection>
	</resultMap>

	<select id="selectForPage" parameterType="java.util.Map" resultType="long">
		select t.id
		  from tab_teach_group t
		 where t.status = 1
		  and t.bu_id = #{bu_id}
		 <if test = "teach_group_name != null and teach_group_name != ''">
		 	and t.teach_group_name like concat('%', #{teach_group_name}, '%')
		 </if>
	</select>
	
	<select id="selectForList" parameterType="java.util.Map" resultMap="teacherGroupMap">
		select t.id,
		       t.teach_group_name,
		       t.status,
		       (case
		         when t.status = 1 then
		          '有效'
		         else
		          '无效'
		       end) as status_name,
		       t.bu_id,
		       (select t1.org_name
		          from tab_organization_info t1
		         where t1.org_type = 3
		           and t1.id = t.bu_id) as bu_name,
		       t.city_id,
		       (select t1.org_name
		          from tab_organization_info t1
		         where t1.org_type = 1
		           and t1.id = t.city_id) as city_name,
		       t.create_user,
		       t.create_time,
		       t.update_user,
		       t.update_time,
		       c_emp.employee_name as create_user_name,
		       u_emp.employee_name as update_user_name,
		       t1.id           as teacher_leader_id,
		       t1.employee_id,
					 t2.id as teacher_id1,
		       t2.teacher_name as teacher_name1,
		       t3.id as teacher_group_ref_id,
		       t3.teacher_id,
		       t4.teacher_name as teacher_name2
		  from tab_teach_group t
		  left join tab_teach_lead t1 on t1.teach_group_id = t.id
		  left join tab_teacher_info t2 on t2.id = t1.teacher_id
		  left join tab_teach_group_ref t3 on t3.teach_group_id = t.id
		  left join tab_teacher_info t4 on t4.id = t3.teacher_id
		  <!-- 新增用户 -->
		  left join tab_user_info c_user on t.create_user = c_user.id
		  left join tab_employee_info c_emp on c_user.employee_id = c_emp.id
		  <!-- 修改用户 -->
		  left join tab_user_info u_user on t.update_user = u_user.id
		  left join tab_employee_info u_emp on u_user.employee_id = u_emp.id
		 where t.status = 1
		  and t.bu_id = #{bu_id}
		 <if test = "teach_group_name != null and teach_group_name != ''">
		 	and t.teach_group_name like concat('%', #{teach_group_name}, '%')
		 </if>
		 <if test="ids != null and ids != ''">
			 and t.id in (${ids})
		 </if>
		 order by t.create_time desc, t.id desc
	</select>
	
	<select id="selectById" parameterType="java.lang.Long"
		resultType="com.edu.erp.model.TeacherGroup">
		select t.id,
		       t.teach_group_name,
		       t.status,
		       (case
		         when t.status = 1 then
		          '有效'
		         else
		          '无效'
		       end) as status_name,
		       t.bu_id,
		       (select t1.org_name
		          from tab_organization_info t1
		         where t1.org_type = 3
		           and t1.id = t.bu_id) as bu_name,
		       t.city_id,
		       (select t1.org_name
		          from tab_organization_info t1
		         where t1.org_type = 1
		           and t1.id = t.city_id) as city_name,
		       t.create_user,
		       t.create_time,
		       t.update_user,
		       t.update_time,
		       c_emp.employee_name as create_user_name,
		       u_emp.employee_name as update_user_name
		  from tab_teach_group t
		  <!-- 新增用户 -->
		  left join tab_user_info c_user on t.create_user = c_user.id
		  left join tab_employee_info c_emp on c_user.employee_id = c_emp.id
		  <!-- 修改用户 -->
		  left join tab_user_info u_user on t.update_user = u_user.id
		  left join tab_employee_info u_emp on u_user.employee_id = u_emp.id
		 where t.id = #{id}
	</select>
	
	<select id="selectLeaderByGroupId" parameterType="java.lang.Long"
		resultType="com.edu.erp.model.TeacherLeader">
		select t.id,
			   t.encoding,
		       t.teacher_name,
		       t.status,
		       t.is_pluralistic,
		       t.phone,
		       t.employee_id,
		       t1.teach_group_id
		  from tab_teacher_info t, tab_teach_lead t1
		 where t.id = t1.teacher_id
		   and t1.teach_group_id = #{id}
	</select>
	
	<select id="selectTeacherByGroupId" parameterType="java.lang.Long"
		resultType="com.edu.erp.model.TeacherGroupRef">
		select t.id,
			   t.id as teacher_id,
		       t.encoding,
		       t.teacher_name,
		       t.status,
		       t.is_pluralistic,
		       t.phone,
		       t1.teach_group_id
		  from tab_teacher_info t, tab_teach_group_ref t1
		 where t.id = t1.teacher_id
		   and t1.teach_group_id = #{id}
	</select>
	
	<insert id="add" parameterType="com.edu.erp.model.TeacherGroup">
		<selectKey keyProperty="id" resultType="long" order="BEFORE">
			select seq_tab_teach_group.nextval as id from dual
		</selectKey>
		insert into tab_teach_group (
			id,
			teach_group_name,
			bu_id,
			city_id,
			status,
			create_user,
			create_time
		)
		values (
			#{id},
			#{teach_group_name},
			#{bu_id},
			#{city_id},
			#{status},
			#{create_user},
			sysdate
		)
	</insert>
	
	<update id="update" parameterType="com.edu.erp.model.TeacherGroup">
		update tab_teach_group set
			<if test = "teach_group_name != null and teach_group_name != ''">
				teach_group_name = #{teach_group_name},
			</if>
			<if test = "status != null">
				status = #{status},
			</if>
			<if test = "bu_id != null">
				bu_id = #{bu_id},
				city_id = (select parent_id from tab_organization_info toi where toi.id = #{bu_id}),
			</if>
			update_user = #{update_user},
			update_time = sysdate
		where id = #{id}
	</update>
	
	<delete id="removeTeacherLeader" parameterType="java.lang.Long">
		delete from tab_teach_lead where teach_group_id = #{teacherGroupId}
	</delete>
	
	<insert id="addTeacherLeader" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close="; end;" separator=";">
			insert into tab_teach_lead (id, teach_group_id, employee_id, teacher_id)
			values (seq_tab_teach_lead.nextval, #{item.teach_group_id}, #{item.employee_id}, #{item.teacher_id})
		</foreach>
	</insert>
	
	<delete id="removeTeacher" parameterType="java.lang.Long">
		delete from tab_teach_group_ref where teach_group_id = #{teacherGroupId}
	</delete>
	
	<insert id="addTeacher" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="begin" close="; end;" separator=";">
			insert into tab_teach_group_ref (id, teach_group_id, teacher_id)
			values (seq_tab_teach_group_ref.nextval, #{item.teach_group_id}, #{item.teacher_id})
		</foreach>
	</insert>

</mapper>