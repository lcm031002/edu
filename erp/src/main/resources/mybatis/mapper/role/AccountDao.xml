<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.erp.dao.AccountDao">

<resultMap type="com.edu.erp.model.Account" id="modelMap">    
    <id column="id" property="id"/>
    <result column="userName" property="accountName"/>
    <result column="status" property="status"/>    
    <result column="password" property="password"/>
    <result column="remark" property="remark"/>    
    <result column="employee_id" property="employeeId"/>    
    <result column="employee_name" property="employeeName"/>
    <result column="create_user" property="create_user"/>
    <result column="create_time" property="create_time"/>
    <result column="update_user" property="update_user"/>
    <result column="update_time" property="update_time"/>
</resultMap> 
	
	<!-- 查询账户信息列表 -->
	<select id="queryAccountForPage" parameterType="java.util.Map"
	resultMap="modelMap">
		SELECT
			tuf.id,
			tuf.userName,
			tuf.password,
			tef.employee_name,
			tuf.employee_id,
			tuf.status
		FROM TAB_USER_INFO tuf
		left join TAB_EMPLOYEE_INFO tef 
		on tuf.employee_id=tef.id
		where tef.status != 0
		  and tuf.status != 0
			<!-- 账户名查询 -->
			<if test="accountName!=null and accountName!=''">
				and tuf.userName like '%'||#{accountName,jdbcType=VARCHAR}||'%'
			</if>
			<if test="employeeId!=null and employeeId!=-1">
				and tuf.employee_id=#{employeeId,jdbcType=NUMERIC}
			</if>
			<if test="employeeName!=null and employeeName!=''">
				and tef.employee_name like '%'||#{employeeName,jdbcType=VARCHAR}||'%'
			</if>
		order by tuf.create_time  desc

	</select>
	
	<!-- 添加账户 -->
	<insert id="addAccount" parameterType="com.edu.erp.model.Account" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO TAB_USER_INFO
		(
		userName,
		employee_id,
		password,
		status,
		create_user,
		create_time
		)
	VALUES(
		#{accountName,jdbcType=VARCHAR},/*账户名称*/
		#{employeeId,jdbcType=NUMERIC},/*员工编码*/
		#{password,jdbcType=VARCHAR},/*账户密码*/
		#{status,jdbcType=NUMERIC},
		#{create_user,jdbcType=NUMERIC},
		#{create_time,jdbcType=TIMESTAMP}
		)
	</insert>
	
	<!-- 修改账户 -->
	<update id="updateAccount" parameterType="com.edu.erp.model.Account">
		UPDATE TAB_USER_INFO SET
			username = #{accountName,jdbcType=VARCHAR},
			<if test="password != null and password != ''">
				password = #{password,jdbcType=VARCHAR},
			</if>
			<if test="employeeId != null and employeeId != ''">
				employee_id = #{employeeId,jdbcType=NUMERIC},
			</if>
			update_user = #{update_user,jdbcType=NUMERIC},
			update_time = #{update_time,jdbcType=TIMESTAMP}
		WHERE id = #{id,jdbcType =NUMERIC}
	</update>
	
	<!-- 禁用指定的一个账户 -->
	<update id="deleteAccount" >
		update tab_user_info t set t.status=#{status, jdbcType =NUMERIC} where t.id=#{accountId, jdbcType =NUMERIC}
	</update>
	
	<!-- 查询已存在账户 -->
	<select id="queryAccountId" parameterType="string" resultType="long">
		select tf.id from tab_user_info tf WHERE tf.username=#{accountName, jdbcType =VARCHAR} limit 1
	</select>

	<select id="queryEmployeeBindedCount" parameterType="com.edu.erp.model.Account" resultType="integer">
		select count(0)
		from tab_user_info tui
		where tui.status != 0
		and tui.employee_id = #{employeeId}
		<if test="id != null and id != ''">
		and tui.id != #{id}
		</if>
	</select>

	<select id="queryByStudentIdAndBuId" resultType="com.edu.erp.model.TAccount">
		SELECT
			t.id,
			t.bu_id,
			t.student_id,
			ifnull(t.fee_amount, 0) as fee_amount
		 FROM t_account t
		where t.student_id = #{studentId}
		  and t.bu_id = #{buId}
	</select>

</mapper>