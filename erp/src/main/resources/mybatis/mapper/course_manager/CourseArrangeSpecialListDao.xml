<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.erp.dao.CourseArrangeSpecialistDao">

  <resultMap type="com.edu.erp.model.CourseArrangeSpecialist" id="courseArrangeSpMap">
    <id property="id" column="id"/>
    <result property="employeeId" column="employee_id"/>
    <result property="employeeEncoding" column="employee_encoding"/>
    <result property="employeeName" column="employee_name"/>
    <result property="buId" column="bu_id"/>
    <result property="buName" column="bu_name"/>
    <result property="status" column="status"/>
    <result property="create_user" column="create_user"/>
    <result property="create_time" column="create_time"/>
    <result property="create_user_name" column="create_user_name"/>
    <result property="update_user" column="update_user"/>
    <result property="update_time" column="update_time"/>
    <result property="update_user_name" column="update_user_name"/>

    <collection property="courseArrangeSpSubjectList" column="arrange_sp_id"
      javaType="ArrayList" ofType="com.edu.erp.model.CourseArrangeSpSubject">
      <id property="id" column="cass_id"/>
      <result property="arrangeSpId" column="cass_arrange_sp_id"/>
      <result property="subjectId" column="cass_subject_id"/>
      <result property="subjectName" column="cass_subject_name"/>
      <collection property="courseArrangeSpGradeList" column="arrange_sp_subject_id"
        javaType="ArrayList" ofType="com.edu.erp.model.CourseArrangeSpGrade">
        <id property="id" column="casg_id"/>
        <result property="arrangeSpId" column="casg_arrange_sp_id"/>
        <result property="arrangeSpSubjectId" column="casg_arrange_sp_subject_id"/>
        <result property="gradeId" column="casg_grade_id"/>
        <result property="gradeName" column="casg_grade_name"/>
      </collection>
    </collection>
  </resultMap>

  <select id="queryForPage" parameterType="map" resultType="long">
    select tcas.id from t_course_arrange_specialist tcas
    where 1 = 1
    <if test="bu_id != null">
      and bu_id = #{bu_id}
    </if>
    <if test="branchId != null">
      and exists (select 1 from tab_organization_info toi where toi.parent_id = tcas.bu_id and toi.id = #{branchId})
    </if>
    <if test="subjectId != null and gradeId != null">
      and exists (select 1 from t_course_arrange_sp_grade tcasg, t_course_arrange_sp_subject tcass
        where tcas.id = tcass.arrange_sp_id
          and tcass.id = tcasg.arrange_sp_subject_id
          and tcas.status = 1
          and tcass.subject_id = #{subjectId}
          and tcasg.grade_id = #{gradeId})
    </if>
  </select>

  <select id="queryForList" parameterType="map" resultMap="courseArrangeSpMap">
    select tcas.id,
           tcas.employee_id,
           tei.encoding as employee_encoding,
           tei.employee_name,
           tcas.bu_id,
           toi.org_name               as bu_name,
           tcas.status,
           tcas.create_user,
           tcas.create_time,
           cvue.employee_name         as create_user_name,
           tcas.update_user,
           tcas.update_time,
           uvue.employee_name         as update_user_name,
           cass.id                    as cass_id,
           cass.arrange_sp_id         as cass_arrange_sp_id,
           cass.subject_id            as cass_subject_id,
           ts.name                    as cass_subject_name,
           casg.id                    as casg_id,
           casg.arrange_sp_id         as casg_arrange_sp_id,
           casg.arrange_sp_subject_id as casg_arrange_sp_subject_id,
           casg.grade_id              as casg_grade_id,
           tdg.grade_name             as casg_grade_name
      from t_course_arrange_specialist tcas
      left join t_course_arrange_sp_subject cass
        on tcas.id = cass.arrange_sp_id
      left join t_course_arrange_sp_grade casg
        on cass.id = casg.arrange_sp_subject_id
      left join tab_employee_info tei
        on tei.id = tcas.employee_id
      left join vt_user_emp cvue
        on cvue.user_id = tcas.create_user
      left join vt_user_emp uvue
        on uvue.user_id = tcas.update_user
      left join tp_subject ts
        on ts.id = cass.subject_id
      left join tab_data_grade tdg
        on tdg.id = casg.grade_id
      left join tab_organization_info toi
        on toi.id = tcas.bu_id
      where 1 = 1
      <if test="ids != null and ids != ''">
        and tcas.id in (${ids})
      </if>
  </select>

  <select id="queryById" parameterType="long" resultMap="courseArrangeSpMap">
    select tcas.id,
          tcas.employee_id,
          tei.encoding as employee_encoding,
          tei.employee_name,
          tcas.bu_id,
          tcas.status,
          tcas.create_user,
          tcas.create_time,
          cvue.employee_name         as create_user_name,
          tcas.update_user,
          tcas.update_time,
          uvue.employee_name         as update_user_name,
          cass.id                    as cass_id,
          cass.arrange_sp_id         as cass_arrange_sp_id,
          cass.subject_id            as cass_subject_id,
          ts.name                    as cass_subject_name,
          casg.id                    as casg_id,
          casg.arrange_sp_id         as casg_arrange_sp_id,
          casg.arrange_sp_subject_id as casg_arrange_sp_subject_id,
          casg.grade_id              as casg_grade_id,
          tdg.grade_name             as casg_grade_name
          from t_course_arrange_specialist tcas
          left join t_course_arrange_sp_subject cass
          on tcas.id = cass.arrange_sp_id
          left join t_course_arrange_sp_grade casg
          on cass.id = casg.arrange_sp_subject_id
          left join tab_employee_info tei
            on tei.id = tcas.employee_id
          left join vt_user_emp cvue
          on cvue.user_id = tcas.create_user
          left join vt_user_emp uvue
          on uvue.user_id = tcas.update_user
          left join tp_subject ts
          on ts.id = cass.subject_id
          left join tab_data_grade tdg
          on tdg.id = casg.grade_id
          where tcas.id = #{id,jdbcType=NUMERIC}
  </select>

  <insert id="add" parameterType="com.edu.erp.model.CourseArrangeSpecialist">
    <selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE">
      select seq_t_course_arrange_sp.nextval AS id from dual
    </selectKey>
    insert into t_course_arrange_specialist
    (
      id,
      employee_id,
      employee_name,
      bu_id,
      status,
      create_user,
      create_time
    )
    VALUES
    (
      #{id, jdbcType=NUMERIC},
      #{employeeId, jdbcType=NUMERIC},
      #{employeeName, jdbcType=VARCHAR},
      #{buId, jdbcType=NUMERIC},
      #{status, jdbcType=NUMERIC},
      #{create_user, jdbcType=NUMERIC},
      sysdate
    )
  </insert>

  <update id="update" parameterType="com.edu.erp.model.CourseArrangeSpecialist">
    update t_course_arrange_specialist set
      <if test="employeeId != null">
      employee_id = #{employeeId, jdbcType=NUMERIC},
      </if>
      <if test="employeeName != null and employeeName != ''">
      employee_name = #{employeeName, jdbcType=VARCHAR},
      </if>
      <if test="buId != null">
      bu_id = #{buId, jdbcType=NUMERIC},
      </if>
      update_user = #{update_user, jdbcType=NUMERIC},
      update_time = sysdate
    where id = #{id}
  </update>

  <delete id="deleteById" parameterType="long">
    DELETE  from t_course_arrange_specialist where id = #{id, jdbcType=NUMERIC}
  </delete>

  <select id="queryCourseArrangeSpecialistCount" parameterType="com.edu.erp.model.CourseArrangeSpecialist" resultType="int">
      select count(0) from t_course_arrange_specialist
      where employee_id = #{employeeId, jdbcType=NUMERIC}
        and  bu_id = #{buId, jdbcType=NUMERIC}
        <if test="id != null">
          and id != #{id}
        </if>
  </select>

  <select id="queryCourseArrangeSp" parameterType="map" resultType="map">
        select tcas.employee_id as "employeeId",
           tcas.employee_name as "employeeName",
           tcas.bu_id as "buId",
           tcass.subject_id as "subjectId",
           tcasg.grade_id as "gradeId",
           ts.name as "subjectName",
           tdg.grade_name as "gradeName"
      from t_course_arrange_specialist tcas,
           t_course_arrange_sp_grade   tcasg,
           t_course_arrange_sp_subject tcass,
           tp_subject ts,
           tab_data_grade tdg
     where tcas.id = tcass.arrange_sp_id
       and tcass.id = tcasg.arrange_sp_subject_id
       and ts.id = tcass.subject_id
       and tdg.id = tcasg.grade_id
       and tcas.status = 1
       and tcass.subject_id = #{subjectId}
       and tcasg.grade_id in (${gradeIds})
       and tcas.bu_id = #{buId}
       and tcas.employee_id != #{employeeId}
  </select>
</mapper>