<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.erp.dao.GcOrderDao">
	
	<!-- 查看线索跟踪是否已经存在成单 -->
	<select id="queryGcOrderForAdd" parameterType="java.util.Map" resultType="com.edu.erp.model.GcOrder">
		select * from gc_order a 
		WHERE 
		a.resource_rec_id=#{resource_rec_id,jdbcType=NUMERIC} 
	</select>
	
	<!-- 订单回填 -->
	<insert id="insertGcOrder" parameterType="com.edu.erp.model.GcOrder">
		<selectKey resultType="long" keyProperty="id" order="BEFORE">
			select SEQ_GC_ORDER.nextval from dual
		</selectKey>
		insert into gc_order(
		 id , 
		 resource_rec_id , 
		 order_no , 
		 fee_amount , 
		 course_count , 
		 remark , 
		 create_user , 
		 create_time , 
		 order_time 
		 )values( 
			 #{id,jdbcType=NUMERIC}, 
			 #{resource_rec_id,jdbcType=NUMERIC}, 
			 #{order_no,jdbcType=VARCHAR}, 
			 #{fee_amount,jdbcType = NUMERIC}, 
			 #{course_count,jdbcType = NUMERIC}, 
			 #{remark,jdbcType=VARCHAR}, 
			 #{create_user,jdbcType=NUMERIC}, 
			 #{create_time,jdbcType=DATE}, 
			 #{order_time,jdbcType=DATE}
		 ) 
	</insert>
	
	<!-- 更新线索跟踪记录状态为成单 -->
	<update id="updateResourceRecToSuccess" >
		update gc_resource_rec 
		SET 
		channel_id = #{channel_id,jdbcType=NUMERIC}, 
		is_suc_order = 1, 
		update_time = sysdate 
		where 
		id = #{id,jdbcType=NUMERIC}
	</update>
	
	<!-- 插入资源处理处理记录 -->
	<insert id="insertResourceProcessRec" parameterType="com.edu.erp.model.GcResourceRecProc">
		insert into GC_RESOURCE_REC_Proc( 
			id , 
			resource_rec_id , 
			opt_type, 
			busi_id, 
			create_user , 
			create_time, 
			busi_content, 
			status 
		)
		values( 
			SEQ_GC_RESOURCE_REC_Proc.nextval, 
			#{resource_rec_id,jdbcType=NUMERIC}, 
			#{opt_type,jdbcType=NUMERIC},
			#{busi_id,jdbcType=NUMERIC}, 
			#{create_user,jdbcType=NUMERIC},
			#{create_time,jdbcType=DATE},
			#{busi_content,jdbcType=VARCHAR},
			1
		) 
	
	</insert>
	
	<select id="queryChannelIdByGcResourceRecId" parameterType="java.lang.Long" resultType="java.lang.Long">
		select CHANNEL_ID from GC_RESOURCE_REC where id = #{id,jdbcType = NUMERIC}
	</select>
	
	<!-- 查询订单总课时 -->
	<select id="sumTotalCourseTimes" parameterType="java.lang.Long" resultType="int">
		select sum(course_total_count) from tab_order_info oi
		left join tab_order_info_detail oide on oide.order_id = oi.id
		where oi.id = #{orderId,jdbcType=NUMERIC}
	</select>
	
	<!-- 将学员的Id保存到线索跟踪记录中 -->
	<update id="updateStudentIdToGcResourceRec">
		update GC_RESOURCE_REC 
		set 
		student_id=#{studentId,jdbcType=NUMERIC}
		where id = #{resource_rec_id,jdbcType =NUMERIC }
	</update>
</mapper>