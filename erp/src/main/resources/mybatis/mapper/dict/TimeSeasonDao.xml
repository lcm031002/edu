<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.erp.dao.TimeSeasonDao">

	<select id="selectForPage" resultType="com.edu.erp.model.TimeSeason" parameterType="java.util.Map">
		select t1.id,
				t1.encoding,
				t1.last_season_id,
				t1.course_season_name,
				t1.season,
				t1.start_date,
				t1.end_date,
				t1.business_type,
				t1.status,
				t1.org_city_id as city_id,
				t1.description,
				t1.create_user,
				t1.create_time,
				t1.update_user,
				t1.update_time,
				(case t1.business_type when 1 then '班级课' when 2 then '一对一' when 3 then '晚辅导' end) business_type_name,
				(case t1.season when 1 then '春季' when 2 then '夏季' when 3 then '秋季' when 4 then '冬季' end) season_name,
			   t2.COURSE_SEASON_NAME  as last_course_season_name,
			   t3.org_name city_name,
			   c_emp.employee_name as create_user_name, u_emp.employee_name as update_user_name
		  from tab_time_season t1
		  left join TAB_TIME_SEASON t2 on t1.LAST_SEASON_ID = t2.id
		  left join	tab_organization_info t3 on t1.org_city_id = t3.id
		 <!-- 新增用户-->
		 left join tab_user_info c_user on t1.create_user = c_user.id
		 left join tab_employee_info c_emp on c_user.employee_id = c_emp.id
		 <!-- 修改用户-->
		 left join tab_user_info u_user on t1.update_user = u_user.id
		 left join tab_employee_info u_emp on u_user.employee_id = u_emp.id
		  where t1.status != 0
		 <if test="course_season_name != null and course_season_name != ''">
			 and t1.course_season_name like concat('%', #{course_season_name}, '%')
		 </if>
		<if test="city_id!=null">
			and t1.org_city_id = #{city_id}
		</if>
		 ORDER BY ifnull(t1.update_time, t1.create_time) DESC, t1.id DESC
	</select>
	
	<select id="selectSeasons" resultType="com.edu.erp.model.DataDictionary" parameterType="com.edu.erp.model.DataDictionary">
			SELECT ID AS VALUE, COURSE_SEASON_NAME AS LABEL
			  FROM TAB_TIME_SEASON
			 WHERE BUSINESS_TYPE = #{businessType,jdbcType=NUMERIC}
			   AND STATUS = 1
			   AND org_city_id = #{city_id,jdbcType=NUMERIC}
			 order by ID desc
	</select>
	
	<select id="selectList"  parameterType="java.util.Map" resultType="com.edu.erp.model.TimeSeason">
		SELECT t.id,
				t.encoding,
				t.last_season_id,
				t.course_season_name,
				t.season,
				t.start_date,
				t.end_date,
				t.business_type,
				t.status,
				t.org_city_id as city_id,
				t.description,
				t.create_user,
				t.create_time,
				t.update_user,
				t.update_time
	  	FROM TAB_TIME_SEASON t
	 	WHERE t.STATUS = 1
		<if test="org_city_id!=null">
			and t.org_city_id = #{org_city_id}
		</if>
	 	<if test="season_id != null and season_id != '' and season_id != -1">
	 	   and t.id = #{season_id}
	 	</if>
	 	<!-- 严格匹配 -->
	 	<if test="strict_season_name != null and strict_season_name != ''">
			and  t.course_season_name = #{strict_season_name,jdbcType=VARCHAR}
		 </if>
		ORDER BY t.end_date DESC
	</select>
	
	<select id="selectById" resultType="com.edu.erp.model.TimeSeason" parameterType="java.lang.String">
		SELECT t.id,
				t.encoding,
				t.last_season_id,
				t.course_season_name,
				t.season,
				t.start_date,
				t.end_date,
				t.business_type,
				t.status,
				t.org_city_id as city_id,
				t.description,
				t.create_user,
				t.create_time,
				t.update_user,
				t.update_time
	  	FROM TAB_TIME_SEASON t
	 	WHERE t.STATUS = 1 AND t.ID = #{id}
		ORDER BY t.ID ASC
	</select>
	
	<insert id="insert" parameterType="com.edu.erp.model.TimeSeason" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO TAB_TIME_SEASON
		(
	       	ENCODING,
	       	LAST_SEASON_ID,
	       	COURSE_SEASON_NAME,
	       	SEASON,
	       	START_DATE,
	       	END_DATE,
	       	BUSINESS_TYPE,
	       	STATUS,
	       	ORG_CITY_ID,
	       	DESCRIPTION,
	       	CREATE_USER,
	       	CREATE_TIME
		) 
		VALUES
		(
			#{encoding,jdbcType=VARCHAR},
			#{last_season_id,jdbcType=NUMERIC},
			#{course_season_name,jdbcType=VARCHAR},
			#{season,jdbcType=NUMERIC},
			#{start_date,jdbcType=VARCHAR},
			#{end_date,jdbcType=VARCHAR},
			#{business_type,jdbcType=NUMERIC},
			#{status,jdbcType=NUMERIC},
			#{city_id,jdbcType=VARCHAR},
			#{description,jdbcType=VARCHAR},
			#{create_user,jdbcType=NUMERIC},
			#{create_time,jdbcType=TIMESTAMP}
		)
	</insert>
	
	<update id="update" parameterType="com.edu.erp.model.TimeSeason">
            UPDATE TAB_TIME_SEASON SET 
	       	LAST_SEASON_ID = #{last_season_id, jdbcType=NUMERIC},
	       	COURSE_SEASON_NAME = #{course_season_name, jdbcType=VARCHAR},
	       	SEASON = #{season, jdbcType=NUMERIC},
	       	START_DATE = #{start_date, jdbcType=VARCHAR},
	       	END_DATE = #{end_date, jdbcType=VARCHAR},
	       	BUSINESS_TYPE = #{business_type, jdbcType=NUMERIC},
	       	DESCRIPTION = #{description, jdbcType=VARCHAR},
	       	UPDATE_USER = #{update_user, jdbcType=NUMERIC},
	       	UPDATE_TIME = #{update_time, jdbcType=TIMESTAMP},
	       	ENCODING = #{encoding, jdbcType=VARCHAR}
	       	WHERE ID = #{id}
	</update>
	
	<update id="deleteByIds" parameterType="java.util.List">
            UPDATE TAB_TIME_SEASON SET STATUS = '0' WHERE ID IN
            <foreach collection="list" open="(" close=")" separator="," item="id">
			#{id}
			</foreach>
	</update>
	
	<update id="changeStatus" parameterType="map" >
		UPDATE tab_time_season
		SET status = ${status},
		    update_time = sysdate,
		    update_user = #{update_user,jdbcType=NUMERIC} 
		WHERE id IN (${ids})
	</update>
	
</mapper>