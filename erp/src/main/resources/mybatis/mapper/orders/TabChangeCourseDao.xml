<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.erp.dao.TabChangeCourseDao">
	<insert id="add" parameterType="com.edu.erp.model.TabChangeCourse">
		<selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE">
			select seq_tab_change_course.nextval as id from dual
		</selectKey>
		insert into tab_change_course (
	    <if test="change_id != null">
	        change_id,
	    </if>
	    <if test="order_id != null">
	        order_id,
	    </if>
	    <if test="order_course_id != null">
	        order_course_id,
	    </if>
	    <if test="course_times != null">
	        course_times,
	    </if>
	    <if test="total_amount != null">
	        total_amount,
	    </if>
	    <if test="attend_amount != null">
	        attend_amount,
	    </if>
	    <if test="pre_amount != null">
	        pre_amount,
	    </if>
	    <if test="change_user != null">
	        change_user,
	    </if>
	    <if test="change_no != null and change_no != ''">
	        change_no,
	    </if>
	    <if test="transfer_flag != null">
	        transfer_flag,
	    </if>
	    <if test="premium_type != null">
	    	premium_type,
	    </if>
	        id)
	    values (
	    <if test="change_id != null">
	        #{change_id},
	    </if>
	    <if test="order_id != null">
	        #{order_id},
	    </if>
	    <if test="order_course_id != null">
	        #{order_course_id},
	    </if>
	    <if test="course_times != null">
	        #{course_times},
	    </if>
	    <if test="total_amount != null">
	        #{total_amount},
	    </if>
	    <if test="change_id != null">
	        #{attend_amount},
	    </if>
	    <if test="pre_amount != null">
	        #{pre_amount},
	    </if>
	    <if test="change_user != null">
	        #{change_user},
	    </if>
	    <if test="change_no != null and change_no != ''">
	        #{change_no},
	    </if>
	    <if test="transfer_flag != null">
	        #{transfer_flag},
	    </if>
	    <if test="premium_type != null">
	        #{premium_type},
	    </if>
	    	#{id})
	</insert>
	
	<update id="update" parameterType="com.edu.erp.model.TabChangeCourse">
		update tab_change_course set
	    <if test="change_id != null">
	       change_id = #{change_id},
	    </if>
	    <if test="order_id != null">
	       order_id = #{order_id},
	    </if>
	    <if test="order_course_id != null">
	       order_course_id = #{order_course_id},
	    </if>
	    <if test="course_times != null">
	       course_times = #{course_times},
	    </if>
	    <if test="pre_amount != null">
	       pre_amount = #{pre_amount},
	    </if>
	    <if test="change_user != null">
	       change_user = #{change_user},
	    </if>
	    <if test="change_no != null and change_no != ''">
	       change_no = #{change_no},
	    </if>
	    <if test="transfer_flag != null">
	       transfer_flag = #{transfer_flag},
	    </if>
	    <if test="attend_amount != null">
	       attend_amount = #{attend_amount},
	    </if>
	       total_amount = #{total_amount}
	    where id = #{id}
	</update>
	
	<update id="updateByChangeNo" parameterType="com.edu.erp.model.TabChangeCourse">
		update tab_change_course set change_id = #{change_id}, order_id = #{order_id}
	    where change_no = #{change_no}
	</update>
	
	<!-- 校验如果存在当前变更课程的主课程、当前课程、当前课程的子课程 变更记录，则不允许变更 -->
	<select id="queryChangeCourseCount" parameterType="java.lang.String" resultType="java.lang.Integer">
		select count(1)
		  from tab_change_course tc,
		       t_order_course    oc,
		       t_order_course    ooc,
		       tc_order_course   otc,
		       t_order_change    chg
		 where
		 <!-- 当前变更订单课程 -->
		 tc.change_no = '11'
		 and tc.order_course_id = oc.id
		 <!--当前变更课程的主课程、当前课程、当前课程的子课程 -->
		 and (oc.id = ooc.id or oc.id = ooc.root_course_id or
		 oc.root_course_id = ooc.id)
		 and ooc.id = otc.order_course_id
		 <!--当前变更课程的主课程、当前课程、当前课程的子课程 变更申请 -->
		 and otc.change_id = chg.id
		 <!--退费 -->
		 and chg.change_type = 1
		 <!--当前变更课程的主课程、当前课程、当前课程的子课程 变更记录中正在过程中的 -->
		 and chg.change_status in (1, 2, 3, 4)
	</select>
	
	<select id="queryByChangeNo" parameterType="java.lang.String" resultType="com.edu.erp.model.TabChangeCourse">
		select * from tab_change_course where change_no = #{changeNo}
	</select>
	
	<select id="queryChangeCourseInfo" parameterType="Map" resultType="com.edu.erp.model.TabChangeCourse">
		select * from tab_change_course where 1=1 
	    <if test="change_id != null">
			and change_id = #{change_id}
	    </if>
	</select>
	
</mapper>