<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.erp.dao.StudentTraceInfoDao">
	<resultMap id="stuTraceInfoMap" type="com.edu.erp.model.StudentTraceInfo">
		<id property="id" column="id" />
		<result property="studentId" column="studentId" />
		<result property="traceDate" column="traceDate" />
		<result property="traceTime" column="traceTime" />
		<result property="relation" column="relation" />
		<result property="relationName" column="relationName" />
		<result property="relationTitle" column="relationTitle" />
		<result property="traceType" column="traceType" />
		<result property="traceTypeName" column="traceTypeName" />
		<result property="tracePurpose" column="tracePurpose" />
		<result property="create_time" column="create_time" />
		<result property="create_user" column="create_user" />
		<result property="create_user_name" column="create_user_name" />
		<result property="studentName" column="studentName" />
		<result property="status" column="status" />
		<result property="statusName" column="statusName" />
		<collection property="studentTraceDetailList" column="tstdTraceId"
					javaType="ArrayList" ofType="com.edu.erp.model.StudentTraceDetail">
			<id property="id" column="tstdId" />
			<result property="traceId" column="tstdTraceId" />
			<result property="type" column="tstdType" />
			<result property="content" column="tstdContent" />
		</collection>
		<collection property="studentTracePlanList" column="tstpTraceId"
					javaType="ArrayList" ofType="com.edu.erp.model.StudentTracePlan">
			<id property="id" column="tstpId" />
			<result property="traceId" column="tstpTraceId" />
			<result property="type" column="tstpType" />
			<result property="content" column="tstpContent" />
		</collection>
		<collection property="studentTraceAttachList" column="tstaTraceId"
					javaType="ArrayList" ofType="com.edu.erp.model.StudentTraceAttach">
			<id property="id" column="tstaId" />
			<result property="traceId" column="tstaTraceId" />
			<result property="fileName" column="tstaFileName" />
			<result property="fileUrl" column="tstaFileUrl" />
			<result property="fileType" column="tstaFileType" />
		</collection>
	</resultMap>

	<select id="selectForPage" parameterType="java.util.Map"
		resultType="com.edu.erp.model.StudentTraceInfo">
		select tsti.id,
				tsti.student_id as studentId,
				tsti.trace_date as traceDate,
				tsti.trace_time as traceTime,
				tsti.relation,
				tsti.relation_title as relationTitle,
				decode(tsti.relation,
					  '1',
					  '父亲',
					  '2',
					  '母亲',
					  '3',
					  '亲戚',
					  '4',
					  '其他',
					  '5',
					  '学员') as relationName,
				tsti.trace_type as traceType,
				(select vdd.name
				  from vt_dict_data vdd
				 where vdd.typeCode = 'traceType'
				   and vdd.code = tsti.trace_type) as traceTypeName,
				tsti.trace_purpose as tracePurpose,
				tsti.create_time,
				tsti.create_user,
				vue.employee_name create_user_name,
				tsi.student_name as studentName,
				tsti.status,
				decode(tsti.status, 0, '删除', 1, '有效', 2, '无效') as statusName,
				(select (case
						 when count(0) > 0 then
						  '是'
						 else
						  '否'
					   end)
				  from tab_student_trace_attach tsta
				 where tsta.trace_id = tsti.id) as hasAttach
		from tab_student_trace_info tsti
		left join vt_user_emp vue on tsti.create_user = vue.user_id
		left join tab_student_info tsi on tsti.student_id = tsi.id
		where tsti.student_id = #{student_id}
		order by tsti.trace_date desc
	</select>

	<select id="queryById" parameterType="long" resultMap="stuTraceInfoMap">
		select tsti.id,
			   tsti.student_id as studentId,
			   tsti.trace_date as traceDate,
			   tsti.trace_time as traceTime,
			   tsti.relation,
			   tsti.relation_title as relationTitle,
			   decode(tsti.relation,
					  '1',
					  '父亲',
					  '2',
					  '母亲',
					  '3',
					  '亲戚',
					  '4',
					  '其他',
					  '5',
					  '自己') as relationName,
			   tsti.trace_type as traceType,
			   (select vdd.name
				  from vt_dict_data vdd
				 where vdd.typeCode = 'traceType'
				   and vdd.code = tsti.trace_type) as traceTypeName,
			   tsti.trace_purpose as tracePurpose,
			   tsti.create_time,
			   tsti.create_user,
			   vue.employee_name create_user_name,
			   tsi.student_name as studentName,
			   tstd.id as tstdId,
			   tstd.trace_id as tstdTraceId,
			   tstd.type as tstdType,
			   tstd.content as tstdContent,
			   tstp.id as tstpId,
			   tstp.trace_id as tstpTraceId,
			   tstp.type as tstpType,
			   tstp.content as tstpContent,
			   tsta.id as tstaId,
			   tsta.trace_id as tstaTraceId,
			   tsta.file_name as tstaFileName,
			   tsta.file_url as tstaFileUrl,
			   tsta.file_type as tstaFileType
		  from tab_student_trace_info tsti
		  left join tab_student_trace_detail tstd
			on tstd.trace_id = tsti.id
		  left join tab_student_trace_plan tstp
			on tstp.trace_id = tsti.id
		  left join tab_student_trace_attach tsta
			on tsta.trace_id = tsti.id
		  left join vt_user_emp vue
			on tsti.create_user = vue.user_id
		  left join tab_student_info tsi
			on tsti.student_id = tsi.id
		 where tsti.id = #{id, jdbcType=NUMERIC}
	</select>

	<insert id="add" parameterType="com.edu.erp.model.StudentTraceInfo">
		<selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE">
			SELECT seq_tab_student_trace_info.nextval AS id from dual
		</selectKey>
		insert into tab_student_trace_info t
		(
			t.id,
			t.student_id,
			t.trace_date,
			t.trace_time,
			t.relation,
		  t.relation_title,
			t.trace_type,
			t.trace_purpose,
			t.status,
			t.create_user,
			t.create_time
		)
		values
		(
			#{id, jdbcType=NUMERIC},
			#{studentId, jdbcType=NUMERIC},
			#{traceDate, jdbcType=VARCHAR},
			#{traceTime, jdbcType=VARCHAR},
			#{relation, jdbcType=VARCHAR},
			#{relationTitle, jdbcType=VARCHAR},
			#{traceType, jdbcType=VARCHAR},
			#{tracePurpose, jdbcType=VARCHAR},
			#{status, jdbcType=NUMERIC},
			#{create_user, jdbcType=NUMERIC},
			#{create_time, jdbcType=TIMESTAMP}
		)
	</insert>

	<update id="update" parameterType="com.edu.erp.model.StudentTraceInfo">
		update tab_student_trace_info t set
		<if test="traceDate != null and traceDate != ''">
			t.trace_date = #{traceDate, jdbcType=VARCHAR},
		</if>
		<if test="traceTime != null and traceTime != ''">
			t.trace_time = #{traceTime, jdbcType=VARCHAR},
		</if>
		<if test="relation != null and relation != ''">
			t.relation = #{relation, jdbcType=VARCHAR},
		</if>
		<if test="relationTitle != null and relationTitle != ''">
			t.relation_title = #{relationTitle, jdbcType=VARCHAR},
		</if>
		<if test="traceType != null and traceType != ''">
			t.trace_type = #{traceType, jdbcType=VARCHAR},
		</if>
		<if test="tracePurpose != null and tracePurpose != ''">
			t.trace_purpose = #{tracePurpose, jdbcType=VARCHAR},
		</if>
		<if test="status != null">
			t.status = #{status, jdbcType=NUMERIC},
		</if>
			t.update_user = #{update_user, jdbcType=NUMERIC},
			t.update_time = #{update_time, jdbcType=TIMESTAMP}
		where id = #{id, jdbcType=NUMERIC}
	</update>

	<select id="queryCourseInfo" parameterType="map" resultType="map">
		select tatt.student_id as "studentId",
			   tsi.student_name as "studentName",
			   toi.org_name as "branchName",
			   tatt.counselor_id as "counselorId",
			   tei.employee_name as "counselorName",
			   tatt.subject_id as "subjectId",
			   ts.name as "subjectName",
			   tatt.encoding as "encoding",
			   to_char(to_date(tatt.course_date, 'yyyyMMdd'), 'yyyy-MM-dd') as "courseDate",
			   tatt.start_time as "startTime",
			   tatt.end_time as "endTime",
			   tatt.teacher_id as "teacherId",
			   tti.teacher_name as "teacherName",
			   tatt.attend_branch_id as "attendBranchId",
			   tgar.course_theme as "courseTheme",
			   tgar.course_message as "courseMessage",
			   tgar.problem_resolvent as "problemResolvent",
			   tgar.last_workinfo as "lastWorkinfo",
			   tgar.current_work as "currentWork",
			   tgar.manager_realize as "managerRealize",
			   tgar.council_schoolschedle as "councilSchoolSchedule",
			   tgar.classroom_info as "classroomInfo"
		  from tab_student_info           tsi,
			   t_attendance               tatt,
			   tab_organization_info      toi,
			   tab_employee_info          tei,
			   tp_subject                 ts,
			   tab_teacher_info           tti,
			   tab_gxh_attend_retroaction tgar
		 where tatt.encoding = tgar.fnumber
		   and tsi.id = tatt.student_id
		   and toi.id = tatt.attend_branch_id
		   and tei.id = tatt.counselor_id
		   and ts.id = tatt.subject_id
		   and tti.id = tatt.teacher_id
		   and tatt.student_id = #{studentId}
		   and to_char(to_date(tatt.course_date, 'yyyyMMdd'), 'yyyy-MM-dd') between
			   #{start_date} and #{end_date}
	</select>

</mapper>