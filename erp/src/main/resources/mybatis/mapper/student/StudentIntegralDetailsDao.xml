<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.erp.dao.StudentIntegralDetailsDao">

	<select id="selectForPage" parameterType="Map" resultType="com.edu.erp.model.StudentIntegralDetails">
		select t.*, 
			b.org_name			as branch_name,
			u_emp.employee_name as update_user_name
		from tab_student_integral_details t
		left join tab_organization_info b on t.branch_id = b.id
		
		<if test="student_id != null and student_id > -1">
			left join tab_student_integral tsi on t.account_id = tsi.id
		</if>
		
		<!-- 修改用户-->
		left join tab_user_info u_user on t.update_user = u_user.id
		left join tab_employee_info u_emp on u_user.employee_id = u_emp.id
		
		where 1=1
		<if test="account_id != null and account_id > -1">
			and t.account_id = #{account_id,jdbcType=NUMERIC}
		</if>
		<if test="branch_id != null and branch_id > -1">
			and t.branch_id = #{branch_id,jdbcType=NUMERIC}
		</if>
		<if test="start_date != null and start_date != ''">
			and DATE_FORMAT(t.datetime, '%Y-%m-%d') >= #{start_date, jdbcType=VARCHAR}
		</if>
		<if test="end_date != null and end_date != ''">
			and DATE_FORMAT(t.datetime, '%Y-%m-%d') &lt;= #{end_date, jdbcType=VARCHAR}
		</if>
		<if test="bu_id != null and bu_id > -1">
			and b.parent_id = #{bu_id,jdbcType=NUMERIC}
		</if>
		<if test="student_id != null and student_id > -1">
			and tsi.student_id = #{student_id,jdbcType=NUMERIC}
		</if>
		
		order by t.datetime desc
	</select>

    <insert id="saveStudentIntegralHt" parameterType="com.edu.erp.model.StudentIntegralDetails">
        insert into tab_student_integral_details
        (
        datetime,<!--业务日期 -->
        account_id,<!--账户ID -->
        change_integral,<!--积分变动值 -->
        crrent_integral,<!--当前值 -->
        after_integral,<!--变化后数值 -->
        update_user,<!--修改人 -->
        update_time,<!--修改时间 -->
        change_type,<!--修改类型：1-考勤 -->
        change_val, <!--考勤值 -->
        attend_amount,<!--累计考勤金额 -->
        last_attend_amount,<!--上一期累计考勤金额 -->
        change_amount, <!--变动金额 -->
        branch_id
        )
        values
        (
        sysdate(),
        #{account_id,jdbcType=NUMERIC},
        #{change_integral,jdbcType=NUMERIC},
        #{crrent_integral,jdbcType=NUMERIC},
        #{after_integral,jdbcType=NUMERIC},
        #{update_user,jdbcType=NUMERIC},
        sysdate(),
        #{change_type,jdbcType=NUMERIC},
        #{change_val,jdbcType=NUMERIC},
        #{attend_amount,jdbcType=NUMERIC},
        #{last_attend_amount,jdbcType=NUMERIC},
        #{change_amount,jdbcType=NUMERIC},
        #{branch_id,jdbcType=NUMERIC}
        )
    </insert>
	
</mapper>