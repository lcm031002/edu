<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.erp.dao.StudentIntegralDao">

	<select id="queryStudentIntegral" parameterType="java.util.HashMap" resultType="com.edu.erp.model.StudentIntegral">
		select t.*, 
			b.org_name			as branch_name,
			u_emp.employee_name as update_user_name
		from tab_student_integral t
		left join tab_organization_info b on t.branch_id = b.id
		
		<!-- 修改用户-->
		left join tab_user_info u_user on t.update_user = u_user.id
		left join tab_employee_info u_emp on u_user.employee_id = u_emp.id
		
		where t.student_id = #{student_id,jdbcType=NUMERIC}	
		<if test="bu_id != null and bu_id > -1">
			and b.parent_id = #{bu_id,jdbcType=NUMERIC}
		</if>
		<if test="branch_id != null and branch_id > -1">
			and t.branch_id = #{branch_id,jdbcType=NUMERIC}
		</if>
		
	</select>
	
	<insert id="insert_integral"  parameterType="java.util.HashMap">
		<selectKey resultType="java.lang.Long" keyProperty="id" order="AFTER" >
      		SELECT seq_tab_student_integral.currval as id from dual
   		</selectKey>
		insert into tab_student_integral t 
		(
			t.ID,
			t.STUDENT_ID,
			t.CRRENT_INTEGRAL,
			t.LAST_INTEGRAL,
			t.UPDATE_USER,
			t.UPDATE_TIME
		)   
		values 
		(
			seq_tab_student_integral.nextval,
			#{STUDENT_ID,jdbcType=NUMERIC},
			#{CRRENT_INTEGRAL,jdbcType=NUMERIC},
			#{LAST_INTEGRAL,jdbcType=NUMERIC},
			#{UPDATE_USER,jdbcType=NUMERIC},
			#{UPDATE_TIME,jdbcType=DATE}
		)
	</insert>
    
    <select id="getIntegral" resultType="com.edu.erp.model.StudentIntegral">
         select
            ID,
            STUDENT_ID,
            CRRENT_INTEGRAL,
            LAST_INTEGRAL,
            UPDATE_USER,
            UPDATE_TIME,
            ATTEND_AMOUNT,
            LAST_ATTEND_AMOUNT,
            BRANCH_ID
         from tab_student_integral
         where student_id = #{studentId,jdbcType=NUMERIC}
           and branch_id = #{branchId,jdbcType=NUMERIC}
    </select>

    <insert id="saveIntegral" parameterType="com.edu.erp.model.StudentIntegral">
        <selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE" >
            SELECT seq_tab_student_integral.nextval AS id from dual
        </selectKey>
        insert into tab_student_integral
        (
        id,
        student_id,<!--学生id-->
        crrent_integral,<!--当前积分值-->
        last_integral,<!--上一次值-->
        update_user,<!--修改人-->
        update_time, <!--修改时间-->
        attend_amount,<!--累计金额-->
        last_attend_amount,<!--累计金额-->
        branch_id
        )
        values
        (
        #{id,jdbcType=NUMERIC},
        #{student_id,jdbcType=NUMERIC},
        #{crrent_integral,jdbcType=NUMERIC},
        #{last_integral,jdbcType=NUMERIC},
        #{update_user,jdbcType=NUMERIC},
        sysdate,
        #{attend_amount,jdbcType=NUMERIC},
        #{last_attend_amount,jdbcType=NUMERIC},
        #{branch_id,jdbcType=NUMERIC}
        )
    </insert>

    <update id="updateIntegral" parameterType="com.edu.erp.model.StudentIntegral">
        update tab_student_integral
           set crrent_integral    = #{crrent_integral,jdbcType=NUMERIC},
               last_integral      = #{last_integral,jdbcType=NUMERIC},
               attend_amount      = #{attend_amount,jdbcType=NUMERIC},
               last_attend_amount = #{last_attend_amount,jdbcType=NUMERIC},
               update_user        = #{update_user,jdbcType=NUMERIC},
               update_time        =  sysdate
         where id = #{id,jdbcType=NUMERIC}
    </update>
</mapper>