<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.erp.dao.CallNameInfoDao">

	<resultMap id="baseResultMap" type="com.edu.erp.attendance.business.CallNameInfo">
		<id property="id" column="id" jdbcType="NUMERIC"/>
		<result property="courseId" column="courseId" jdbcType="NUMERIC"/>
		<result property="courseName" column="courseName" jdbcType="VARCHAR"/>
		<result property="startDate" column="startDate" jdbcType="DATE"/>
		<result property="endDate" column="endDate" jdbcType="DATE"/>
		<result property="latestStartDate" column="latestStartDate" jdbcType="DATE"/>
		<result property="latestEndDate" column="latestEndDate" jdbcType="DATE"/>
		<result property="chineseTeacherName" column="chineseTeacherName" jdbcType="VARCHAR"/>
		<result property="foreignTeacherName" column="foreignTeacherName" jdbcType="VARCHAR"/>
		<result property="courseTimeCount" column="courseTimeCount" jdbcType="NUMERIC"/>
		<result property="classCycle" column="classCycle" jdbcType="VARCHAR"/>
		<collection property="classSchedulingList" column="courseId" javaType="java.util.ArrayList"
					ofType="com.edu.erp.attendance.business.ClassScheduling" select="listClassScheduling"/>
		<collection property="studentInfoList" column="courseId" javaType="java.util.ArrayList"
					ofType="com.edu.erp.attendance.business.StudentInfo" select="listStudentInfo" />
	</resultMap>

	<resultMap id="baseResultMapHt" type="com.edu.erp.attendance.business.CallNameInfo">
		<id property="id" column="id" jdbcType="NUMERIC"/>
		<result property="courseId" column="courseId" jdbcType="NUMERIC"/>
		<result property="courseName" column="courseName" jdbcType="VARCHAR"/>
		<result property="startDate" column="startDate" jdbcType="DATE"/>
		<result property="endDate" column="endDate" jdbcType="DATE"/>
		<result property="latestStartDate" column="latestStartDate" jdbcType="DATE"/>
		<result property="latestEndDate" column="latestEndDate" jdbcType="DATE"/>
		<result property="chineseTeacherName" column="chineseTeacherName" jdbcType="VARCHAR"/>
		<result property="foreignTeacherName" column="foreignTeacherName" jdbcType="VARCHAR"/>
		<result property="courseTimeCount" column="courseTimeCount" jdbcType="NUMERIC"/>
		<result property="classCycle" column="classCycle" jdbcType="VARCHAR"/>
		<collection property="classSchedulingList" column="id" javaType="java.util.ArrayList"
					ofType="com.edu.erp.attendance.business.ClassScheduling" select="listClassSchedulingHt"/>
		<collection property="studentInfoList" column="courseId" javaType="java.util.ArrayList"
					ofType="com.edu.erp.attendance.business.StudentInfo" select="listStudentInfo" />
	</resultMap>

	<resultMap id="studentInfoResultMap" type="com.edu.erp.attendance.business.StudentInfo">
		<id property="studentId" jdbcType="NUMERIC" column="studentId" />
		<result property="chineseName" column="chineseName" jdbcType="VARCHAR"/>
		<result property="foreignName" column="foreignName" jdbcType="VARCHAR"/>
	</resultMap>

	<resultMap id="classSchedulingResultMap" type="com.edu.erp.attendance.business.ClassScheduling">
		<id property="schedulingId" column="schedulingId" jdbcType="NUMERIC"/>
		<result property="classTimeNo" column="classTimeNo" jdbcType="NUMERIC"/>
		<result property="classDate" column="classDate" jdbcType="DATE"/>
	</resultMap>

	<select id="listStudentInfo" resultMap="studentInfoResultMap">
		select si.id studentId, si.student_name chineseName
		from t_order_course oc
		join t_order o
		on o.id = oc.order_id
		join tab_student_info si
		on si.id = o.student_id
		where o.order_status = 1 and oc.course_id = #{courseId,jdbcType=NUMERIC}
		order by si.student_name
	</select>

	<select id="listClassSchedulingHt" resultMap="classSchedulingResultMap" parameterType="long">
		select scheduling_id schedulingId,
		class_time_no classTimeNo,
		class_date classDate
		from Tab_Callname_Scheduling_Info csi
		where callname_id = #{callNameId,jdbcType=NUMERIC}
		order by class_time_no asc
	</select>

	<select id="listClassScheduling" resultMap="classSchedulingResultMap" parameterType="long">
		select cs.id schedulingId,
		cs.course_times classTimeNo,
		to_date(to_char(cs.course_date), 'yyyyMMdd') classDate
		from t_course_scheduling cs
		where course_id = #{courseId,jdbcType=NUMERIC}
		order by cs.course_times asc
	</select>

	<select id="getCallNameInfo" parameterType="long" resultMap="baseResultMap">
		select
		tc.id courseId,
		tc.course_name courseName,
		tc.start_date startDate,
		tc.end_date endDate,
		nvl(sa_cn_tea.teacher_name,sa_main_tea.teacher_name) chineseTeacherName,
		nvl(sa_en_tea.teacher_name,sa_assist_tea.teacher_name) foreignTeacherName,
		tc.course_count courseTimeCount,
		tc.ATTEND_CLASS_PERIOD classCycle
		from t_course tc
		left join t_course_scheduling_assist sa_cn on tc.id = sa_cn.course_id and sa_cn.course_key='course_tearcher_cn'
		left join t_course_scheduling_assist sa_en on tc.id = sa_en.course_id and sa_en.course_key='course_tearcher_en'
		left join tab_teacher_info sa_cn_tea on sa_cn_tea.id = sa_cn.course_val
		left join tab_teacher_info sa_en_tea on sa_en_tea.id = sa_en.course_val
		left join tab_teacher_info sa_main_tea on sa_main_tea.id = tc.teacher_id
		left join tab_teacher_info sa_assist_tea on sa_assist_tea.id = tc.assteacher_id
		where tc.id = #{courseId,jdbcType=NUMERIC}
	</select>

	<select id="getCallNameInfoHt" resultMap="baseResultMapHt" parameterType="long">
		select ci.id                   id,
			   ci.course_id            courseId,
			   ci.course_name          courseName,
			   ci.course_time_count    courseTimeCount,
			   ci.start_date           startDate,
			   ci.end_date             endDate,
			   ci.class_cycle          classCycle,
			   tc.start_date           latestStartDate,
			   tc.end_date             latestEndDate,
			   ci.chinese_teacher_name chineseTeacherName,
			   ci.foreign_teacher_name foreignTeacherName
		  from TAB_CALLNAME_INFO ci
		 left join t_course tc on ci.course_id = tc.id
		 where ci.course_id = #{courseId, jdbcType = NUMERIC}
	</select>

	<insert id="insertCallNameInfo" parameterType="com.edu.erp.attendance.business.CallNameInfo">
		 <selectKey resultType="long" keyProperty="id" order="BEFORE" statementType="STATEMENT">
			 select seq_tab_callname_info.nextval as id from dual
		 </selectKey>
		 insert into tab_callname_info ci(
            ci.id,
            ci.course_id,
            ci.course_name,
            ci.start_date,
            ci.end_date,
            ci.chinese_teacher_name,
            ci.foreign_teacher_name,
            ci.course_time_count,
            ci.class_cycle
		 ) values (
				#{id,jdbcType=NUMERIC},
				#{courseId,jdbcType=NUMERIC},
				#{courseName,jdbcType=NUMERIC},
				#{startDate,jdbcType=DATE},
				#{endDate,jdbcType=DATE},
				#{chineseTeacherName,jdbcType=VARCHAR},
				#{foreignTeacherName,jdbcType=VARCHAR},
				#{courseTimeCount,jdbcType=NUMERIC},
				#{classCycle,jdbcType=NUMERIC}
		 )

	</insert>

	<insert id="batchInsertCallNameInfoScheduling" parameterType="list" >

		<foreach collection="classSchedulingList" separator=";" item="classScheduling" close=";end;" open="begin">
			insert into Tab_Callname_Scheduling_Info csi
			values
			(seq_tab_callname_scheduling.nextval,
			#{classScheduling.schedulingId, jdbcType = NUMERIC},
			#{classScheduling.classTimeNo, jdbcType = NUMERIC},
			#{classScheduling.classDate, jdbcType = DATE},
			#{callNameId, jdbcType = NUMERIC})
		</foreach>

	</insert>
</mapper>