<div ng-controller="BSrefund2refundCtrl as bsCtrl">
    <div class="panel panel-default" style="margin-bottom: 10px;">
        <div class="panel-heading font-bold">
            退费业务流程
        </div>
        <div class="panel-body" style="padding: 15px;">
            <div style="float:left; width:98%; margin-top:10px;">
                <div class="step">第一步 搜索学员</div>
                <div class="step">第二步 选择课程</div>
                <div class="step">第三步 选择课次</div>
                <div class="step">第四步 确认公式</div>
            </div>
            <div style="float:left; width:98%; margin-left:10px; margin-top:10px;">
                <div class="progress"  >
                    <div class="progress-bar" role="progressbar" aria-valuenow="60"
                         aria-valuemin="0" aria-valuemax="200" style="width: {{step*25}}%; ">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="panel panel-default" style="margin-bottom: 10px;" ng-if="step == 1">
        <div class="panel-heading font-bold">
            第一步 搜索学员
        </div>
        <div class="panel-body" style="padding: 15px;">
            <div>
                <div class="col-lg-6">
                    <div class="form-group">
                        <label class="col-sm-3 col-md-3 col-lg-3 fl" style="line-height: 34px;">搜索关键字</label>
                        <div class="input-group col-sm-9  col-md-9  col-lg-9 ">
                            <input type="text" class="form-control" ng-change=queryStudentOnChange() ng-model="page.searchInfo"/>
                            <div class="associatebox droplist" ng-if="onGoingQuery!=''&&onGoingQuery==true">
							<ul >
								<li
									ng-repeat="student in  studentList"
									ng-click="selectedStudent(student)">{{student.studentEncoding}}-{{student.studentName}}</li>
							</ul>
						</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6" align="left">
                    <button type="button" class="btn btn-default"  ng-click="queryStudent()">搜索学员</button>
                </div>
            </div>
            <table class="table table-striped table-hover table-bordered">
                <tr>
                    <th> </th>
                    <th>学员姓名</th>
                    <th>学员编码</th>
                    <th>就读学校</th>
                    <th>年段</th>
                    <th>联系方式</th>
                    <th>最近时间</th>
                </tr>
                <tr ng-repeat="student in studentList" ng-if="studentList && studentList.length" ng-click="checkedStudent(student)" >
                    <td>
                        <input type="checkbox" checked ng-if="student.checked"/>
                        <input type="checkbox" ng-if="!student.checked"/>
                    </td>
                    <td>{{student.studentName}}</td>
                    <td>{{student.studentEncoding}}</td>
                    <td>{{student.branchName}}</td>
                    <td>{{student.gradeName}}</td>
                    <td>{{student.contactInfo}}</td>
                    <td>{{student.currentTime}}</td>
                </tr>
                <tr ng-if="!studentList||!studentList.length">
                    <td colspan="7"> 暂无数据. </td>
                </tr>
            </table>
            <div align="center">
                <ul class="pagination">
                    <li ng-repeat="i in getNumber(totalPage) track by $index" class="{{ $index+1==currentPage ? 'active':'' }}" ng-click="queryOrderInfo()">
                        <span>{{$index+1}}</span>
                    </li>
                </ul>
            </div>

            <div style=" width:200px; margin:auto; text-align:center;">
                <button type="button" class="btn btn-primary"  style="width:200px; " ng-click="nextStep(1,2)" ng-disabled="!curStudent">
                    下一步
                </button>
            </div>
        </div>
    </div>

    <div class="panel panel-default" style="margin-bottom: 10px;" ng-if="step == 2">
        <div class="panel-heading font-bold">
            第二步 选择课程
        </div>
        <div class="panel-body" style="padding: 15px;">
            <h3>已报课程</h3>
            <table class="table table-striped table-hover table-bordered">
                <col width="5%">
                <col width="10%">
                <col width="10%">
                <col width="20%">
                <col width="5%">
                <col width="5%">
                <col width="5%">
                <col width="5%">
                <col width="10%">
                <col width="10%">
                <col width="10%">

                <tr>
                    <th> </th>
                    <th>订单id</th>
                    <th>订单编码</th>
                    <th>课程</th>
                    <th>原价</th>
                    <th>现价</th>
                    <th>总价</th>
                    <th>预结转</th>
                    <th>剩余课时</th>
                    <th>教师/编码</th>
                    <th>上课时间</th>
                </tr>
                <tr ng-repeat="course in selectedCourseList" ng-if="selectedCourseList && selectedCourseList.length" ng-click="checkedCourse(course)" >
                    <td>
                        <input type="checkbox" checked ng-if="course.checked"/>
                        <input type="checkbox" ng-if="!course.checked"/>
                    </td>
                    <td>{{course.orderId}}</td>
                    <td>{{course.orderNo}}</td>
                    <td>{{course.courseName}}</td>
                    <td>{{course.unitPrice}}</td>
                    <td>{{course.actualPrice}}</td>
                    <td>{{course.totalPrice}}</td>
                    <td>{{course.forward}}</td>
                    <td>{{course.courseTimes}}</td>
                    <td>{{course.teacherName}}/{{course.teacherCode}}</td>
                    <td>{{course.startTime}}~{{course.endTime}}</td>
                </tr>
                <tr ng-if="!selectedCourseList||!selectedCourseList.length">
                    <td colspan="11" align="center"> 请选择课程. </td>
                </tr>
            </table>

            <div style="margin:auto;" align="center">
                <button type="button" class="btn btn-primary"  style="width:200px;margin-right: 10px; " ng-click="nextStep(2,1)">
                    上一步
                </button>
                <button type="button" class="btn btn-primary"  style="width:200px; " ng-click="nextStep(2,3)" ng-disabled="!curCourse">
                    下一步
                </button>
            </div>
        </div>
    </div>

    <div class="panel panel-default" style="margin-bottom: 10px;" ng-if="step == 3">
        <div class="panel-heading font-bold">
            第三步 选择课次
        </div>
        <div class="panel-body" style="padding: 15px;">
            <h3>已选课程（{{curCourse.courseName}}）</h3>
            <table class="table table-striped table-hover table-bordered">
                <col width="5%">
                <col width="19%">
                <col width="19%">
                <col width="19%">
                <col width="19%">
                <col width="19%">
                <tr>
                    <th></th>
                    <th>订单ID</th>
                    <th>订单编码</th>
                    <th>详单ID</th>
                    <th>课次</th>
                    <th>状态</th>
                </tr>
                <tr ng-repeat="time in selectedCourseTimesList" ng-if="selectedCourseTimesList && selectedCourseTimesList.length" ng-click="checkedTimes(time)" >
                    <td>
                        <input type="checkbox" checked ng-if="time.checked"/>
                        <input type="checkbox" ng-if="!time.checked"/>
                    </td>
                    <td>{{time.orderId}}</td>
                    <td>{{time.orderNo}}</td>
                    <td>{{time.orderCourseId}}</td>
                    <td>{{time.courseTime}}</td>
                    <td>{{time.stateName==''?'正常':time.stateName}}</td>
                </tr>
                <tr ng-if="!selectedCourseTimesList||!selectedCourseTimesList.length">
                    <td colspan="6" align="center"> 没有数据. </td>
                </tr>
            </table>

            <div style="margin:auto;" align="center">
                <button type="button" class="btn btn-primary"  style="width:200px;margin-right: 10px; " ng-click="nextStep(3,2)">
                    上一步
                </button>
                <button type="button" class="btn btn-primary"  style="width:200px; " ng-click="nextStep(3,4)" ng-disabled="!curCoursetime || !curCoursetime.length">
                    下一步
                </button>
            </div>
        </div>
    </div>

    <div class="panel panel-default" style="margin-bottom: 10px;" ng-if="step == 4">
        <div class="panel-heading font-bold">
            第四步 确认公式
        </div>
        <div class="panel-body" style="padding: 15px;">
            <h3>报班学员</h3>
            <table class="table table-striped table-hover table-bordered">
                <tr>
                    <th>学员姓名</th>
                    <th>学员编码</th>
                    <th>就读学校</th>
                    <th>年段</th>
                    <th>联系方式</th>
                    <th>最近时间</th>
                </tr>
                <tr ng-repeat="student in studentList" ng-if="studentList && studentList.length && student.checked">
                    <td>{{student.studentName}}</td>
                    <td>{{student.studentEncoding}}</td>
                    <td>{{student.branchName}}</td>
                    <td>{{student.gradeName}}</td>
                    <td>{{student.contactInfo}}</td>
                    <td>{{student.currentTime}}</td>
                </tr>
                <tr ng-if="!studentList||!studentList.length">
                    <td colspan="6"> 暂无数据. </td>
                </tr>
            </table>
            <h3>已选课程</h3>
            <table class="table table-striped table-hover table-bordered">
                <col width="10%">
                <col width="10%">
                <col width="20%">
                <col width="10%">
                <col width="5%">
                <col width="5%">
                <col width="5%">
                <col width="10%">
                <col width="10%">
                <col width="10%">

                <tr>
                    <th>订单id</th>
                    <th>订单编码</th>
                    <th>课程</th>
                    <th>原价</th>
                    <th>现价</th>
                    <th>总价</th>
                    <th>预结转</th>
                    <th>剩余课时</th>
                    <th>教师/编码</th>
                    <th>上课时间</th>
                </tr>
                <tr ng-repeat="course in selectedCourseList" ng-if="selectedCourseList && selectedCourseList.length && course.checked">

                    <td>{{course.orderId}}</td>
                    <td>{{course.orderNo}}</td>
                    <td>{{course.courseName}}</td>
                    <td>{{course.unitPrice}}</td>
                    <td>{{course.actualPrice}}</td>
                    <td>{{course.totalPrice}}</td>
                    <td>{{course.forward}}</td>
                    <td>{{course.courseTimes}}</td>
                    <td>{{course.teacherName}}/{{course.teacherCode}}</td>
                    <td>{{course.startTime}}~{{course.endTime}}</td>
                </tr>
                
                 <tr>
                    <td colspan="10" align="center" ng-if="isLoading==true">
                                              系统正在提交中...... <img src="img/icons/big_load.gif" alt=" 系统正在提交中......" >
                      </td>
                  </tr>
                <tr ng-if="!selectedCourseList||!selectedCourseList.length">
                    <td colspan="10" align="center"> 请选择课程. </td>
                </tr>
            </table>

            <h3>退费课时：</h3>
            <div class="col-lg-12" style="margin-bottom: 10px;">
                <span>总退费课次为：{{curCoursetime.length}}节，分别为：第{{curCoursetimeStr}}节课</span>
            </div>

            <h3>退费计算公式：</h3>
            <div class="col-lg-12"  style="margin-bottom: 10px;">
                <span ng-if = "curCourse.unitPrice == curCourse.actual_price">退费公式为：退费金额 = 退费课次 * 课程单价</span>
                <span ng-if = "curCourse.unitPrice != curCourse.actual_price">退费公式为：退费金额 = 报班总额 - 课程原价 * ( 报班课时-退费课次) </span>
            </div>

            <h3>退费金额计算：</h3>
            <div class="col-lg-12" style="margin-bottom: 10px;">
                <span ng-if = "curCourse.unitPrice == curCourse.actual_price">退费金额为：退费金额 = {{curCoursetime.length}} * {{curCourse.actual_price}}</span>
                <span ng-if = "curCourse.unitPrice != curCourse.actual_price">退费金额为：{{allRefund}} = {{curCourse.totalPrice}} - {{curCourse.unitPrice}} * ( {{curCourse.totalCourseTimes}}-{{curCoursetime.length}}) </span>
                <span ng-if = "curCourse.unitPrice != curCourse.actual_price" ng-if = "allRefund<0" style="color: red">
                    ，退费计算金额为负值，实际退费调整为退 0 元；
                </span>
            </div>
            <div class="col-lg-12"  >
                <div class="form-group">
                    <label class="col-sm-3 col-md-3 col-lg-3 fl" style="line-height: 34px;">冻结补扣：</label>
                    <div class="input-group col-sm-3 col-md-3 col-lg-3 ">
                        <input type="number" class="form-control" ng-model="refund.premiumDeduction"/>
                    </div>
                </div>
            </div>
            
         
            <div class="col-lg-12"  style="margin-bottom: 10px;">
                <div class="form-group">
                    <label class="col-sm-3 col-md-3 col-lg-3 fl" style="line-height: 34px;">备注：</label>
                    <div class="input-group col-sm-3 col-md-3 col-lg-3 ">
                        <input type="text" ng-model="refund.refundRemark" ng-max="100" class="form-control" />
                    </div>
                </div>
            </div>

            <div style="margin:auto;" align="center">
                <button type="button" class="btn btn-primary"  style="width:200px;margin-right: 10px; " ng-click="nextStep(4,3)">
                    上一步
                </button>
                <button type="button" class="btn btn-primary"  style="width:200px; " ng-click="postRefund()">
                    提交
                </button>
            </div>
        </div>
    </div>

    <div ng-include="'templates/segment/course_times.html'"></div>
    <div ng-include="'templates/segment/student_account.html'"></div>
</div>
    <style>
	.drop-field .droplist {
		display: none;
	}
	
	.drop-field .droplist:hover {
		display: block;
	}
	
	.drop-field:hover .droplist {
		display: block;
	}
	
	.associatebox {
		border: 1px solid #ccc;
		width: 100%;
		padding-top: 3px;
		padding-bottom: 3px;
		position: absolute;
		right: 0px;
		z-index: 10001;
		top: 34px;
		background-color: #fff;
	}
	
	.associatebox ul {
		padding: 0px;
		margin: 0px;
		list-style: none;
	}
	
	.associatebox ul li {
		line-height: 26px;
		padding-left: 10px;
		color: #333333;
		list-style: none;
	}
	.associatebox ul li:hover {
		background: #428bca;
		cursor: pointer;
		color: #fff;
	}
	</style>
	