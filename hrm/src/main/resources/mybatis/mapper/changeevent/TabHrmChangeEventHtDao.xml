<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--Handler_id 处理人id 改成Varchar -->
<mapper namespace="com.ebusiness.hrm.dao.TabHrmChangeEventHtDao">
	<resultMap type="com.ebusiness.hrm.model.TabHrmChangeEventHt"
		id="TabHrmChangeEventHtMap">
		<id property="id" column="id" />
		<result property="employee_id" column="employee_id" />
		<result property="employee_name" column="employee_name" />
		<result property="organiser" column="organiser" />
		<result property="organiser_name" column="organiser_name" />
		<result property="application_time" column="application_time" />
		<result property="last_update_time" column="last_update_time" />
		<result property="application_type" column="application_type" />
		<result property="application_name" column="application_name" />
		<result property="approval_status" column="approval_status" />
		<result property="handler_opinion" column="handler_opinion" />
		<result property="is_effect" column="is_effect" />
		<result property="handler_id" column="handler_id" />
		<result property="handler_name" column="handler_name" />
		<result property="task_id" column="task_id" />
		<result property="enclosure" column="enclosure" />
		<result property="bu_id" column="bu_id" />
		<result property="bu_name" column="bu_name" />
		<result property="branch_id" column="branch_id" />
		<result property="branch_name" column="branch_name" />
		<result property="step" column="step" />
		<result property="event_id" column="event_id" />
	</resultMap>


	<!--异动历史列表查询 -->
	<select id="querychangeeventht" parameterType="java.util.Map"
		resultMap="TabHrmChangeEventHtMap">
		select thch.id id,
		to_char(thch.application_time, 'yyyy-mm-dd hh:mm:ss') application_time,
		to_char(thch.last_update_time, 'yyyy-mm-dd hh:mm:ss')
		last_update_time,
		t.bu_id bu_id,
		t.bu_name bu_name,
		t1.branch_id branch_id,
		t1.branch_name branch_name,
		emp.employee_name employee_name,
		thch.event_id event_id,
		tht.id application_type,
		tht.type_name application_name,
		t2.organiser organiser_name,
		t3.handler_name as handler_name,
		thch.task_id task_id,
		thch.step step
		from tab_hrm_changeevent_ht thch
		left join tab_employee_info emp on emp.id = thch.employee_id
		left join tab_emp_org_post teop on teop.emp_id = thch.employee_id
		left join tab_hrmevent_type tht on thch.application_type = tht.id
		left join (select org_name as bu_Name, id as bu_id
		from tab_organization_info
		where org_type = 3) t on t.bu_id = teop.bu_id
		left join (select org_name as branch_Name, id as branch_id
		from tab_organization_info
		where org_type = 4) t1 on t1.branch_id = teop.branch_id
		left join (select distinct (a.id), a.employee_name as organiser
		from tab_employee_info a, tab_hrm_changeevent b
		where a.id = b.organiser) t2 on t2.id = thch.organiser
		left join (select wm_concat(a.employee_name) as handler_name ,b.id as id
		from tab_employee_info a, tab_hrm_changeevent_ht b
		where a.id in
		(select * from table(fn_str_split(b.handler_id, ','))) group by b.id) t3
		on t3.id=thch.id
		<where>
			emp.status = 1
			<!--团队 -->
			<if test="bu_id != null and bu_id !=''">
				and t.bu_id=#{bu_id}
			</if>
			<!--校区 -->
			<if test="branch_id!='' and branch_id!=null">
				and t1.branch_id=#{branch_id}
			</if>
			<!--搜索框 员工、当前处理人、发起人 -->
			<if test="serach !=null and serach !=''">
				and (t2.organiser like '%'||#{serach}||'%' or
				t3.handler_name like '%'||#{serach}||'%' or emp.employee_name like
				'%'||#{serach}||'%' )
			</if>
		</where>
		order by thch.id, thch.application_time desc
	</select>

	<!--人事异动历史 -->
	<insert id="insertChangeeventHt" parameterType="com.ebusiness.hrm.model.TabHrmChangeEvent">
		insert into
		tab_hrm_changeevent_ht
		(id,
		employee_id,
		organiser,
		application_time,
		application_type,
		handler_id,
		approval_status,
		handler_opinion,
		is_effect,
		task_id,
		enclosure,
		last_update_time,
		step,
		event_id)
		values
		(seq_hrm_changeevent_ht.nextval,
		#{employee_id,jdbcType=NUMERIC},
		#{organiser,jdbcType=NUMERIC},
		#{application_time},
		#{application_type,jdbcType=NUMERIC},
		#{handler_id,jdbcType=VARCHAR},
		#{approval_status,jdbcType=NUMERIC},
		#{flnal_opinion,jdbcType=VARCHAR},
		#{is_effect,jdbcType=NUMERIC},
		#{task_id,jdbcType=VARCHAR},
		#{enclosure,jdbcType=VARCHAR},
		sysdate,
		#{step,jdbcType=NUMERIC},
		#{id,jdbcType=NUMERIC}
		)

	</insert>

	<!-- 通过异动id 来查询异动历史结果 -->
	<select id="queryeventHisotry" parameterType="java.util.Map"
		resultMap="TabHrmChangeEventHtMap">
		select
		thch.step step,
		thch.handler_id handler_id,
		emp.employee_name
		handler_name,
		thch.handler_opinion handler_opinion,
		thch.last_update_time last_update_time,
		thch.enclosure enclosure
		from
		tab_hrm_changeevent_ht thch
		left join
		tab_employee_info emp on
		thch.handler_id = emp.id
		<where>
			thch.event_id=#{event_id}
		</where>
		order by thch.id,thch.last_update_time
	</select>

	<select id="queryeventht" parameterType="java.util.Map"
		resultMap="TabHrmChangeEventHtMap">
		select
		thch.step step,
		thch.handler_id handler_id,
		emp.employee_name
		handler_name,
		thch.handler_opinion handler_opinion,
		thch.last_update_time last_update_time,
		thch.enclosure enclosure
		from
		tab_hrm_changeevent_ht thch
		left join
		tab_employee_info emp on
		thch.handler_id = emp.id
		<where>
			thch.event_id=#{event_id}

			and thch.step &lt;=#{step}

		</where>
		order by thch.id,thch.last_update_time

	</select>

</mapper>