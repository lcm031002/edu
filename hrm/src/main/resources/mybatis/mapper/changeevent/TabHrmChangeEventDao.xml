<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ebusiness.hrm.dao.TabHrmChangeEventDao">
	<resultMap type="com.ebusiness.hrm.model.TabHrmChangeEvent"
		id="TabHrmChangeEventMap">
		<id property="id" column="id" />
		<result property="employee_id" column="employee_id" />
		<result property="employee_name" column="employee_name" />
		<result property="organiser" column="organiser" />
		<result property="organiser_name" column="organiser_name" />
		<result property="application_time" column="application_time" />
		<result property="last_update_time" column="last_update_time" />
		<result property="application_type" column="application_type" />
		<result property="application_name" column="application_name" />
		<result property="approval_status" column="approval_status" />
		<result property="flnal_opinion" column="flnal_opinion" />
		<result property="is_effect" column="is_effect" />
		<result property="handler_id" column="handler_id" />
		<result property="handler_name" column="handler_name" />
		<result property="task_id" column="task_id" />
		<result property="enclosure" column="enclosure" />
		<result property="bu_id" column="bu_id" />
		<result property="bu_name" column="bu_name" />
		<result property="branch_id" column="branch_id" />
		<result property="branch_name" column="branch_name" />
		<result property="tha_is_effect" column="tha_is_effect" />
		<result property="event_id" column="event_id" />
		<result property="step" column="step" />
	</resultMap>

	<!--通过异动id 来查询 -->
	<select id="querylastchangeInfo" resultMap="TabHrmChangeEventMap"
		parameterType="java.util.Map">
		select thc.id id,
		thc.employee_id employee_id,
		thc.organiser organiser,
		thc.application_time application_time,
		thc.last_update_time last_update_time,
		thc.application_type application_type,
		thc.approval_status approval_status,
		thc.final_opinion flnal_opinion,
		thc.handler_id handler_id,
		thc.task_id task_id,
		thc.enclosure enclosure,
		thc.step step
		from tab_hrm_changeevent thc where thc.id=#{event_id}
	</select>

	<!--异步列表查询 -->
	<select id="querychangeevent" parameterType="java.util.Map"
		resultMap="TabHrmChangeEventMap">
		select thc.id id,
		thc.employee_id employee_id,
		to_char(thc.application_time,'yyyy-mm-dd hh:mm:ss') application_time,
		t.bu_id bu_id,
		t.bu_name bu_name,
		t1.branch_id branch_id,
		t1.branch_name
		branch_name,
		tha.is_effect tha_is_effect,
		emp.employee_name
		employee_name,
		tht.id application_type,
		tht.type_name application_name,
		t2.organiser organiser_name,
		t3.handler_name as handler_name,
		thc.task_id
		task_id,
		thc.step step
		from
		tab_hrm_changeevent thc
		left join tab_employee_info emp on
		emp.id
		=
		thc.employee_id
		left join tab_hrmevent_attention tha on
		tha.event_id=thc.id
		left join tab_hrmevent_type tht on
		thc.application_type
		= tht.id
		left join tab_emp_org_post teop on
		teop.emp_id =
		thc.employee_id
		left join (select org_name as bu_Name, id
		as bu_id
		from
		tab_organization_info
		where org_type = 3) t on t.bu_id =
		teop.bu_id
		left
		join (select org_name as branch_Name, id as branch_id
		from
		tab_organization_info
		where org_type = 4) t1 on t1.branch_id =
		teop.branch_id
		left join(select distinct(a.id),a.employee_name as
		organiser from
		tab_employee_info a ,tab_hrm_changeevent b where
		a.id=b.organiser) t2
		on t2.id=thc.organiser
		left join (select wm_concat(a.employee_name) as handler_name ,b.id as id
		from tab_employee_info a, tab_hrm_changeevent b
		where a.id in
		(select * from table(fn_str_split(b.handler_id, ','))) group by b.id) t3
		on t3.id=thc.id
		<where>
		<!--搜索框 -->
		<!--团队 -->
		<if test="bu_id != null and bu_id !=''">
			and t.bu_id=#{bu_id}
		</if>
		<!--校区 -->
		<if test="branch_id!='' and branch_id!=null">
			and t1.branch_id=#{branch_id}
		</if>
		<!-- 类型 -->
		<if test="type_id !=null and type_id !=''">
			and tht.id=#{type_id}
		</if>
		<!--搜索框 员工、当前处理人、发起人 -->
		<if test="serach !=null and serach !=''">
			and (t2.organiser like '%'||#{serach}||'%' or
			t3.handler_name like '%'||#{serach}||'%' or emp.employee_name like
			'%'||#{serach}||'%' )
		</if>
	</where>
		order by thc.id, thc.application_time desc
	</select>

	<!-- 人事异动 关注与取消关注 -->
	<update id="updateFollow" parameterType="java.util.Map">
		merge into
		tab_hrmevent_attention tha
		using (select #{event_id} as event_id
		from
		dual ) b
		on(tha.event_id=b.event_id)
		when matched then
		update set
		tha.is_effect=#{tha_is_effect}
		, tha.CREATE_TIME=sysdate where
		tha.event_id=#{event_id}
		when not matched then
		insert
		(id,EMPLOYEE_ID,EVENT_ID,IS_EFFECT,CREATE_TIME)
		values
		(seq_hrmevent_attention.nextval,#{employee_id},#{event_id},#{tha_is_effect},sysdate)

	</update>

	<select id="queryeventtype" resultType="com.ebusiness.hrm.model.TabHrmEventtype">
		select id ,type_name from
		TAB_HRMEVENT_TYPE
	</select>

	<!--人事异动插入数据 -->
	<insert id="insertEvent" parameterType="java.util.Map">
		insert into
		TAB_HRM_CHANGEEVENT
		(id,
		EMPLOYEE_ID,
		Organiser,
		Application_Time,
		Application_Type,
		APPROVAL_STATUS,
		Final_Opinion,
		IS_EFFECT,
		<!-- Handler_Id,Varchar2 类型 -->
		<!-- Task_Id, -->
		Enclosure,
		Last_Update_Time,
		step)
		values
		(seq_hrm_changeevent.nextval,
		#{employeeId},
		#{handler_id},
		sysdate,
		#{application_type},
		1,
		null,
		1,
		<!-- #{handler_id}, -->
		<!-- #{task_id}, -->
		null,
		sysdate,
		1)
	</insert>

	<select resultType="java.lang.String" id="querytaskid"
		parameterType="java.util.Map">
		select DBid_
		from
		jbpm4_task
		where execution_id_ =
		#{processInstanceId,jdbcType=VARCHAR}
	</select>

	<!--人事异动参数表 插入数据 -->
	<insert id="insertEventParam" parameterType="java.util.List">
		insert into Tab_Hrm_Changeevent_Param
		(id ,applyid, Parametername,
		Parameterkey, Parametervalue)
		select
		seq_hrm_changeevent_param.nextval,A.*
		from(
		<foreach collection="list" item="item" separator="union all"
			index="index">
			select
			#{item.applyid},
			#{item.Parameterkey},
			#{item.Parameterkey},
			#{item.Parametervalue}
			from dual
		</foreach>
		) A
	</insert>

	<!--流程id 人事异动表 -->
	<select id="selectChangeId" parameterType="java.util.Map"
		resultType="java.lang.Integer">
		select id
		from TAB_HRM_CHANGEEVENT a
		where a.task_id like
		(select DBid_
		from
		jbpm4_task
		where execution_id_ =#{processInstanceId})
	</select>

	<!-- 查询记录 -->
	<select id="queryChangeEventid" resultMap="TabHrmChangeEventMap"
		parameterType="java.util.Map">
		select*from tab_hrm_changeevent thc where thc.id=(select
		id from TAB_HRM_CHANGEEVENT a
		where a.task_id like
		(select DBid_ from
		jbpm4_task where execution_id_
		=#{processInstanceId,jdbcType=VARCHAR}))
	</select>

	<!--查询详情 -->
	<select id="queryChangeInfo" parameterType="java.util.Map"
		resultType="com.ebusiness.hrm.model.TabHrmChangeeventParam">
		select*from TAB_HRM_CHANGEEVENT_PARAM where
		applyid=#{event_id}
	</select>

	<!--人事异动点击详情处理 -->
	<update id="updateChangeEvent" parameterType="java.util.Map">
		update
		tab_hrm_changeevent thc
		set thc.handler_id = #{handler_id},
		thc.approval_status = #{approval_status},
		final_opinion=#{outcome,jdbcType=VARCHAR},
		<if test="remark!=null">
			thc.enclosure=#{remark},
		</if>
		thc.task_id =
		(select dbid_
		from jbpm4_task
		where execution_id_ = (select
		execution_
		from
		jbpm4_hist_task where dbid_=(select task_id from
		tab_hrm_changeevent where id= #{event_id}))),
		thc.last_update_time =
		sysdate,
		step=#{step},
		is_effect=#{is_effect}
		where thc.id =
		#{event_id}
	</update>


	<update id="lastupdateChangeEvent" parameterType="java.util.Map">
		update
		tab_hrm_changeevent thc
		set thc.handler_id = #{handler_id},
		thc.approval_status = #{approval_status},
		thc.task_id='已失效',
		thc.last_update_time =
		sysdate,
		thc.final_opinion=#{outcome,jdbcType=VARCHAR},
		<if test="remark!=null">
			thc.enclosure=#{remark,jdbcType=VARCHAR},
		</if>
		step=#{step,jdbcType=NUMERIC},
		is_effect=#{is_effect,jdbcType=NUMERIC}
		where thc.id = #{event_id,jdbcType=NUMERIC}
	</update>

	<select id="querystep" parameterType="java.util.Map"
		resultType="com.ebusiness.hrm.model.TabHrmChangeEvent">
		select *from tab_hrm_changeevent where id = #{event_id,jdbcType=NUMERIC}
	</select>

</mapper>