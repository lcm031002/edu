<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ebusiness.hrm.dao.EmployeeExtDao">
<resultMap type="Map" id="typeMap">    
    <id column="id" property="id"/>    
    <result column="name" property="dictTypeName"/>
    <result column="status" property="status"/>    
    <result column="fieldStatus" property="fieldStatus"/>    
    <result column="fieldName" property="fieldName"/>    
    <result column="fieldKey" property="fieldKey"/>    
    <result column="fieldType" property="fieldType"/>    
    <result column="fieldDictType" property="fieldDictType"/>    
    <result column="createId" property="createId"/>    
    <result column="createTime" property="createTime"/>    
    <result column="updateId" property="updateId"/>    
    <result column="updateTime" property="updateTime"/>    
    <result column="remark" property="remark"/>    
    <result column="oldFieldKey" property="oldFieldKey"/>        
</resultMap> 
	
	<!-- 查询员工档案定义项 -->
	<select id="queryEmployeeExt" resultMap="typeMap">
		SELECT eer.id,eer.FIELDNAME,eer.FIELDKEY,eer.remark,fieldStatus,
				case 
				when eer.FIELDSTATUS= '0' then '禁用'
				when eer.FIELDSTATUS= '1' then '启用'
				when eer.FIELDSTATUS= '2' then '默认'	
				else ''
				end status,
				eer.FIELDTYPE,eer.FIELDDICTTYPE,eer.CREATEId,eer.CREATETIME,eer.UPDATEId,eer.UPDATETIME,edt.name
			FROM ebs_employeeext_reg eer
			left join ebs_dict_type edt on eer.FIELDDICTTYPE=edt.id
			order by eer.id
	</select>
	
	<!-- 查询员工档案定义项启用的字段信息 -->
	<select id="queryEmployeeExtField" resultMap="typeMap">
		SELECT eer.id,eer.FIELDNAME,eer.FIELDKEY,eer.remark,fieldStatus,
				case 
				when eer.FIELDSTATUS= '0' then '禁用'
				when eer.FIELDSTATUS= '1' then '启用'
				when eer.FIELDSTATUS= '2' then '默认'	
				else ''
				end status,
				eer.FIELDTYPE,eer.FIELDDICTTYPE,eer.CREATEId,eer.CREATETIME,eer.UPDATEId,eer.UPDATETIME,edt.name
			FROM ebs_employeeext_reg eer
			left join ebs_dict_type edt on eer.FIELDDICTTYPE=edt.id
			where eer.fieldStatus=2 or eer.fieldStatus=1
			order by eer.id
	</select>
	
	<!-- 添加员工档案定义项 -->
	<insert id="insertEmployeeExt" parameterType="com.ebusiness.hrm.model.EmployeeExt" >
	INSERT INTO ebs_employeeext_reg 
	(	id,
		fieldName,
		fieldKey,
		fieldStatus,
		fieldType,
		fieldDictType,
		remark,
		createId,
		createTime
		
	)
	VALUES
	(	seq_ebs_employeeext_reg.nextval,
		#{fieldName,jdbcType=VARCHAR},
		#{fieldKey,jdbcType=VARCHAR},
		#{fieldStatus,jdbcType=NUMERIC},
		#{fieldType,jdbcType=VARCHAR},
		#{fieldDictType,jdbcType=NUMERIC},
		#{remark,jdbcType=VARCHAR},
		#{createId,jdbcType=NUMERIC},
		sysdate
	)
	</insert>
	
	<!-- 添加员工档案管理字段 -->
	<insert id="insertEmployeefield" parameterType="com.ebusiness.hrm.model.EmployeeExt">
		alter table TAB_EMPLOYEE_INFO 
		<if test="fieldType.equals('字符串') and fieldKey!=null and fieldKey!=''">
			add ${fieldKey} VARCHAR(20)
		</if>
		<if test="fieldType.equals('日期') and fieldKey!=null and fieldKey!=''">
			add ${fieldKey} Date
		</if>
		<if test="fieldType.equals('数据字典') and fieldKey!=null and fieldKey!=''">
			add ${fieldKey} NUMERIC
		</if>
	</insert>
	
	
	<!-- 更新员工档案定义项 -->
	<update id="updateEmployeeExt" parameterType="com.ebusiness.hrm.model.EmployeeExt">
	UPDATE 
		ebs_employeeext_reg
	set
		fieldName = #{fieldName,jdbcType=VARCHAR},
		fieldKey=#{fieldKey,jdbcType=VARCHAR},
		<!-- fieldStatus = #{fieldStatus,jdbcType=NUMERIC}, -->
		fieldType = #{fieldType,jdbcType=VARCHAR},
		fieldDictType = #{fieldDictType,jdbcType=NUMERIC},
		remark = #{remark,jdbcType=VARCHAR},	
		updateId=#{updateId,jdbcType=NUMERIC},	
		updateTime=sysdate
		 WHERE id = #{id}
	</update>
	
	<!-- 根据id查询修改前字段信息 -->
	<select id="queryEmployeeField" parameterType="Integer" resultType="com.ebusiness.hrm.model.EmployeeExt">
		select fieldKey from ebs_employeeext_reg where id=#{id,jdbcType=NUMERIC}
	</select>
	
	<!-- 修改员工档案信息表字段名 -->
	<update id="updateEmployeeField" parameterType="com.ebusiness.hrm.model.EmployeeExt">
		alter table TAB_EMPLOYEE_INFO rename column ${oldFieldKey} to ${fieldKey}
	</update>
	
	<!-- 禁用启用 -->
	<update id="removeEmployeeExt" parameterType="Integer">
		UPDATE 
			ebs_employeeext_reg eer
		SET
			eer.fieldStatus = abs(nvl(eer.fieldStatus,0)-1)
			WHERE id=#{id}
	</update>
</mapper>