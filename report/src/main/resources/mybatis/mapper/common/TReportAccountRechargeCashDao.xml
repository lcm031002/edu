<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.report.framework.dao.TReportAccountRechargeCashDao">
	<select id="queryReport" parameterType="map"
		resultType="com.edu.report.model.TAccountRechargeCash">
		select * from(select
			t.id,
			t.task_flow,
			t.opt_encoding,
			t.calc_date,
			t.opt_type,
			t.opt_name,
			t.bu_id,
			t.bu_name,
			t.branch_id,
			t.branch_name,
			t.zhuanru,
			t.student_id,
			t.student_name,
			t.student_encoding,
			ifnull (t.fee_amount, 0) fee_amount,
			ifnull (t.pay_cash, 0) pay_cash,
			ifnull (t.pay_card, 0) pay_card,
			ifnull (t.pay_trans, 0) pay_trans,
			t.qukuan,
			t.student_bankcard,
			t.company_bankcard,
			t. STATUS,
			t.status_name,
			t.creatmaker,
			t.remark
		from t_account_recharge_cash t
		where t.bu_id = #{bu_id}
		<if test="branch_id != null and branch_id != -1">
			<![CDATA[ and t.branch_id = #{branch_id, jdbcType=NUMERIC} ]]>
		</if>
		 <if test="validBranchIds != null and validBranchIds !='' ">
			   and t.branch_id  in (${validBranchIds})
	     </if>
		<if test="start_date != null and start_date != ''">
			<![CDATA[ and t.calc_date >= #{start_date} ]]>
		</if>
		<if test="end_date != null and end_date != ''">
			<![CDATA[ and t.calc_date <= #{end_date} ]]>
		</if>
		<if test="end_date != null and end_date != ''">
			<![CDATA[ and t.calc_date <= #{end_date} ]]>
		</if>
		<if test="input_user_name != null and input_user_name != ''">
			<![CDATA[ and t.creatmaker like '%${input_user_name}%' ]]>
		</if>
		order by t.opt_encoding ) t
		union all
		select null id,
		null task_flow,
		null opt_encoding,
		'合计' calc_date,
		null opt_type,
		null opt_name,
		null bu_id,
		null bu_name,
		null branch_id,
		null branch_name,
		null zhuanru,
		null student_id,
		null student_name,
		null student_encoding,
		sum(ifnull(fee_amount, 0)) fee_amount,
		sum(ifnull(pay_cash, 0)) pay_cash,
		sum(ifnull(pay_card, 0)) pay_card,
		sum(ifnull(pay_trans, 0)) pay_trans,
		null qukuan,
		null student_bankcard,
		null company_bankcard,
		null status,
		null status_name,
		null creatmaker,
		sum(ifnull(total, 0)) remark from(
		select  sum(ifnull(fee_amount, 0)) fee_amount,
		sum(ifnull(pay_cash, 0)) pay_cash,
		sum(ifnull(pay_card, 0)) pay_card,
		sum(ifnull(pay_trans, 0)) pay_trans,
		count(0) total
		from t_account_recharge_cash t
		where t.bu_id = #{bu_id}
		<if test="branch_id != null and branch_id != -1">
			<![CDATA[ and t.branch_id = #{branch_id, jdbcType=NUMERIC} ]]>
		</if>
		<if test="validBranchIds != null and validBranchIds !='' ">
			and t.branch_id  in (${validBranchIds})
		</if>
		<if test="start_date != null and start_date != ''">
			<![CDATA[ and t.calc_date >= #{start_date} ]]>
		</if>
		<if test="end_date != null and end_date != ''">
			<![CDATA[ and t.calc_date <= #{end_date} ]]>
		</if>
		<if test="end_date != null and end_date != ''">
			<![CDATA[ and t.calc_date <= #{end_date} ]]>
		</if>
		<if test="input_user_name != null and input_user_name != ''">
			<![CDATA[ and t.creatmaker like '%${input_user_name}%' ]]>
		</if>
		group by  t.calc_date,t.opt_encoding,fee_amount,pay_cash,pay_card,pay_trans)temp
	</select>
	
	<delete id="removeByTaskFlow" parameterType="map">
		delete from t_account_recharge_cash where task_flow = #{taskFlow}
	</delete>
	
	<insert id="addByTaskFlow" parameterType="map">
		insert into t_account_recharge_cash 
		(
				  opt_encoding,
				  calc_date,
				  opt_type,
				  opt_name,
				  bu_id,
				  bu_name,
				  branch_id,
				  branch_name,
				  student_id,
				  student_encoding,
				  student_name,
				  fee_amount,
				  qukuan,
				  pay_cash,
				  pay_card,
				  pay_trans,
				  student_bankcard,
				  company_bankcard,
				  status,
				  status_name,
				  remark,
				  task_flow,
				  creatmaker
		)
		select
		       d.encoding opt_encoding,
		       date_format(d.confirm_time,'%Y-%m-%d') calc_date,
		       d.dynamic_type opt_type,
		       case when d.dynamic_type = 1 then '充值'
                when d.dynamic_type = 2 then '转账'
		            when d.dynamic_type = 3 then '理赔'
								when d.dynamic_type = 4 then '取款'
		            when d.dynamic_type = 5 then '充值作废'
		            when d.dynamic_type = 6 then '理赔作废'
		            when d.dynamic_type = 7 then '取款作废'
		            when d.dynamic_type = 8 then '一元转校'
		            when d.dynamic_type = 9 then '一元结转'
		            when d.dynamic_type = -1 then '期初导入' end opt_name,
		       d.bu_id,
		       bu.org_name bu_name,
		       d.branch_id,
		       branch.org_name branch_name,
		       d.student_id,
		       stu.encoding student_encoding,
		       stu.student_name,
		       case
		         when d.dynamic_type in (5, 4) or
		              (chang.change_flag = 1 and d.dynamic_type = 2) then
		          d.money * -1
		         else
		          d.money
		       end fee_amount,
		       d.money_fee qukuan,
		       case
		         when d.dynamic_type in (5, 4) then
		           case when d.pay_mode = 1 then
                    d.money * -1
	             else 0
               end
		         else
		          case when d.pay_mode = 1 then
                    d.money
	             else 0
               end
		       end pay_cash,
		       case
		         when d.dynamic_type in (5, 4) then
		           case when d.pay_mode = 2 then
                    d.money * -1
	             else 0
               end
		         else
		           case when d.pay_mode = 2 then
                    d.money
	             else 0
               end
		       end pay_card,
		       case
		         when d.dynamic_type in (5, 4) then
		           case when d.pay_mode = 3 then
                    d.money * -1
	             else 0
               end
		         else
		          case when d.pay_mode = 3 then
                    d.money
	             else 0
               end
		       end pay_trans,
		       r.card_no student_bankcard,
		       acc.account_num company_bankcard,
		       d.status,
		       case when d.status = 1 then  '待审批'when d.status =  2 then  '未通过'when d.status =  3 then  '生效'when d.status =  4 then '作废' end status_name,
		       d.remark,
		       '${taskFlow}' as task_flow,
		        i.employee_name creatmaker
		  from t_account_dynamic d
		  left join tab_user_info ui on ui.id = d.create_user
      	  left join tab_employee_info i on ui.employee_id=i.id
		  left join t_account_change chang
		    on d.id = chang.dynamic_id
		  left join t_account ac
		    on ac.id = chang.account_id
		  left join t_account_recharge_info r
		    on d.id = r.dynamic_id
		  left join tab_organization_info branch
		    on d.branch_id = branch.id
		  join tab_organization_info bu
		    on d.bu_id = bu.id
		  join tab_student_info stu
		    on ac.student_id = stu.id
		  left join tab_data_company_account acc
		    on acc.id = r.company_account
		 where d.dynamic_type != -1
			and date_format(d.confirm_time,'%Y%m%d') BETWEEN #{minOperateNo} AND #{maxOperateNo}
	</insert>
	
</mapper>